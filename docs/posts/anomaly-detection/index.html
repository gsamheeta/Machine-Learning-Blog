<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Samheeta">
<meta name="dcterms.date" content="2023-12-06">
<meta name="description" content="Anomaly detection in Machine Learning focuses on identifying rare or unusual instances in data that significantly differ from the majority of normal observations, aiding in the detection of outliers or irregular patterns.">

<title>MLBlog - Anomaly/Outlier detection</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<script type="text/javascript">
window.PlotlyConfig = {MathJaxConfig: 'local'};
if (window.MathJax && window.MathJax.Hub && window.MathJax.Hub.Config) {window.MathJax.Hub.Config({SVG: {font: "STIX-Web"}});}
if (typeof require !== 'undefined') {
require.undef("plotly");
requirejs.config({
    paths: {
        'plotly': ['https://cdn.plot.ly/plotly-2.27.0.min']
    }
});
require(['plotly'], function(Plotly) {
    window._Plotly = Plotly;
});
}
</script>

<script src="https://unpkg.com/@jupyter-widgets/html-manager@*/dist/embed-amd.js" crossorigin="anonymous"></script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">MLBlog</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html" rel="" target="">
 <span class="menu-text">Samheeta</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/gsamheeta" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <div class="quarto-title-block"><div><h1 class="title">Anomaly/Outlier detection</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
                  <div>
        <div class="description">
          Anomaly detection in Machine Learning focuses on identifying rare or unusual instances in data that significantly differ from the majority of normal observations, aiding in the detection of outliers or irregular patterns.
        </div>
      </div>
                </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Samheeta </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">December 6, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<p><strong>Contents:</strong></p>
<ul>
<li><p>Introduction to Anomaly or Outlier Detection.</p></li>
<li><p>Example of Anomaly Detection with real data <a href="https://www.kaggle.com/datasets/mlg-ulb/creditcardfraud">Credit Card dataset</a></p></li>
<li><p>Data Visualization</p></li>
<li><p>Data processing</p></li>
<li><p>Anomaly Detection</p></li>
</ul>
<section id="anomaly-or-outlier-detection" class="level4">
<h4 class="anchored" data-anchor-id="anomaly-or-outlier-detection"><strong>Anomaly or Outlier Detection</strong></h4>
<p>Anomaly or outlier detection is a crucial aspect of data analysis and machine learning, involving the identification of data points or observations that deviate significantly from the expected or normal behavior within a dataset. These anomalies, often representing rare events, errors, or unusual patterns, are detected using various techniques such as statistical methods, machine learning algorithms, distance-based approaches, and domain-specific rules, enabling their recognition in applications like fraud detection, quality control, network security, and predictive maintenance, ultimately enhancing decision-making and problem-solving in diverse fields.</p>
<p>In the context of machine learning, anomaly detection can be approached using various techniques and algorithms, including:</p>
<ul>
<li><p>Statistical Methods: Statistical approaches involve using statistical measures such as mean, standard deviation, and probability distributions to identify outliers. Data points that fall outside predefined statistical thresholds are considered anomalies.</p></li>
<li><p>Machine Learning Algorithms: Machine learning models can be trained to detect anomalies. Some popular algorithms for this purpose include:</p></li>
</ul>
<p>One-Class SVM (Support Vector Machine): It is a supervised learning algorithm that learns to classify data points as either “normal” or “anomalous” based on the majority class (usually “normal” data).</p>
<p>Isolation Forest: This algorithm isolates anomalies by recursively partitioning the data into subsets, making it efficient for high-dimensional datasets.</p>
<p>Autoencoders: These neural networks are used for unsupervised learning and can learn to reconstruct normal data. Data points that are poorly reconstructed are considered anomalies.</p>
<ul>
<li><p>Distance-Based Methods: These methods compute distances or dissimilarities between data points and identify outliers as those with unusually large distances from their nearest neighbors. k-nearest neighbors (KNN) and DBSCAN (Density-Based Spatial Clustering of Applications with Noise) are examples of distance-based techniques.</p></li>
<li><p>Time Series Anomaly Detection: In time series data, specialized methods like Seasonal Decomposition of Time Series (STL), Exponential Smoothing, or Recurrent Neural Networks (RNNs) can be used to detect anomalies over time.</p></li>
<li><p>Rule-Based Systems: Domain-specific knowledge can be applied to define rules that identify anomalies based on specific criteria. This approach is often used in fields like cybersecurity.</p></li>
<li><p>Unsupervised and Semi-Supervised Learning: Anomaly detection can be performed in an unsupervised manner, where the model learns from data without the need for labeled anomalies, or in a semi-supervised manner with a limited amount of labeled data.</p></li>
</ul>
<p>The choice of method depends on the characteristics of the data, the specific problem, and the available resources. Anomaly detection is a valuable tool in machine learning for uncovering irregularities and potential issues within datasets, leading to improved decision-making and problem-solving in various domains.</p>
</section>
<section id="importing-libraries" class="level2">
<h2 class="anchored" data-anchor-id="importing-libraries">Importing libraries</h2>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># File system manangement</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time, psutil, os, gc</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Mathematical functions</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> math</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Data manipulation</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Plotting and visualization</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.patches <span class="im">as</span> mpatches</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>sns.set_theme()</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.express <span class="im">as</span> px</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.graph_objects <span class="im">as</span> go</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> plotly.subplots <span class="im">import</span> make_subplots</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> plotly.offline <span class="im">import</span> init_notebook_mode, iplot</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>init_notebook_mode(connected<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Train-test split</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Progress bar for loop</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm.contrib <span class="im">import</span> itertools</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="runtime-and-memory-usage" class="level2">
<h2 class="anchored" data-anchor-id="runtime-and-memory-usage">Runtime and memory usage</h2>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Recording the starting time, complemented with a stopping time check in the end to compute process runtime</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>start <span class="op">=</span> time.time()</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Class representing the OS process and having memory_info() method to compute process memory usage</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>process <span class="op">=</span> psutil.Process(os.getpid())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The Anomaly Detection in credit card transactions is aiming to identify fraudulent transactions among a highly imbalanced dataset. Anomalies, or outliers, are rare observations that deviate significantly from the majority of data points. Anomaly detection techniques, including machine learning, are employed to automate this process. The project’s objective is to fit a probability distribution based on authentic transactions and use it to identify new transactions as authentic or fraudulent, with the target variable playing no role in constructing the distribution.</p>
<p>The evaluation metric considers True Positives (correctly predicting positive outcomes), True Negatives (correctly predicting negative outcomes), False Positives (incorrectly predicting positive outcomes), and False Negatives (incorrectly predicting negative outcomes). Metrics like Precision, Recall, F1-Score, and MCC are used to evaluate model performance. F2-Score is given special importance due to the higher cost associated with false negatives in this context.</p>
<p>Feature selection is crucial due to high dimensionality, with 30 features in the dataset. Features are selected based on their ability to distinguish between authentic and fraudulent transactions, considering the distributions of each feature for both target classes. Features exhibiting distinct distributions are retained for classification purposes.</p>
<p>The dataset contains information on credit card transactions made by European cardholders and can be accessed via Kaggle. The data includes transaction time, PCA-transformed features (V1 to V28), transaction amount, and a binary class variable indicating authenticity (0 for authentic, 1 for fraudulent).</p>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Loading the data</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> pd.read_csv(<span class="st">'C:/Users/Lenovo/Desktop/MLBlog-gh-pages/posts/anomaly-detection/creditcard.csv'</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(pd.Series({<span class="st">"Memory usage"</span>: <span class="st">"</span><span class="sc">{:.2f}</span><span class="st"> MB"</span>.<span class="bu">format</span>(data.memory_usage().<span class="bu">sum</span>()<span class="op">/</span>(<span class="dv">1024</span><span class="op">*</span><span class="dv">1024</span>)),</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"Dataset shape"</span>: <span class="st">"</span><span class="sc">{}</span><span class="st">"</span>.<span class="bu">format</span>(data.shape)}).to_string())</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>data.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Memory usage         67.36 MB
Dataset shape    (284807, 31)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="3">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Time</th>
<th data-quarto-table-cell-role="th">V1</th>
<th data-quarto-table-cell-role="th">V2</th>
<th data-quarto-table-cell-role="th">V3</th>
<th data-quarto-table-cell-role="th">V4</th>
<th data-quarto-table-cell-role="th">V5</th>
<th data-quarto-table-cell-role="th">V6</th>
<th data-quarto-table-cell-role="th">V7</th>
<th data-quarto-table-cell-role="th">V8</th>
<th data-quarto-table-cell-role="th">V9</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">V21</th>
<th data-quarto-table-cell-role="th">V22</th>
<th data-quarto-table-cell-role="th">V23</th>
<th data-quarto-table-cell-role="th">V24</th>
<th data-quarto-table-cell-role="th">V25</th>
<th data-quarto-table-cell-role="th">V26</th>
<th data-quarto-table-cell-role="th">V27</th>
<th data-quarto-table-cell-role="th">V28</th>
<th data-quarto-table-cell-role="th">Amount</th>
<th data-quarto-table-cell-role="th">Class</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0.0</td>
<td>-1.359807</td>
<td>-0.072781</td>
<td>2.536347</td>
<td>1.378155</td>
<td>-0.338321</td>
<td>0.462388</td>
<td>0.239599</td>
<td>0.098698</td>
<td>0.363787</td>
<td>...</td>
<td>-0.018307</td>
<td>0.277838</td>
<td>-0.110474</td>
<td>0.066928</td>
<td>0.128539</td>
<td>-0.189115</td>
<td>0.133558</td>
<td>-0.021053</td>
<td>149.62</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0.0</td>
<td>1.191857</td>
<td>0.266151</td>
<td>0.166480</td>
<td>0.448154</td>
<td>0.060018</td>
<td>-0.082361</td>
<td>-0.078803</td>
<td>0.085102</td>
<td>-0.255425</td>
<td>...</td>
<td>-0.225775</td>
<td>-0.638672</td>
<td>0.101288</td>
<td>-0.339846</td>
<td>0.167170</td>
<td>0.125895</td>
<td>-0.008983</td>
<td>0.014724</td>
<td>2.69</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>1.0</td>
<td>-1.358354</td>
<td>-1.340163</td>
<td>1.773209</td>
<td>0.379780</td>
<td>-0.503198</td>
<td>1.800499</td>
<td>0.791461</td>
<td>0.247676</td>
<td>-1.514654</td>
<td>...</td>
<td>0.247998</td>
<td>0.771679</td>
<td>0.909412</td>
<td>-0.689281</td>
<td>-0.327642</td>
<td>-0.139097</td>
<td>-0.055353</td>
<td>-0.059752</td>
<td>378.66</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>1.0</td>
<td>-0.966272</td>
<td>-0.185226</td>
<td>1.792993</td>
<td>-0.863291</td>
<td>-0.010309</td>
<td>1.247203</td>
<td>0.237609</td>
<td>0.377436</td>
<td>-1.387024</td>
<td>...</td>
<td>-0.108300</td>
<td>0.005274</td>
<td>-0.190321</td>
<td>-1.175575</td>
<td>0.647376</td>
<td>-0.221929</td>
<td>0.062723</td>
<td>0.061458</td>
<td>123.50</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>2.0</td>
<td>-1.158233</td>
<td>0.877737</td>
<td>1.548718</td>
<td>0.403034</td>
<td>-0.407193</td>
<td>0.095921</td>
<td>0.592941</td>
<td>-0.270533</td>
<td>0.817739</td>
<td>...</td>
<td>-0.009431</td>
<td>0.798278</td>
<td>-0.137458</td>
<td>0.141267</td>
<td>-0.206010</td>
<td>0.502292</td>
<td>0.219422</td>
<td>0.215153</td>
<td>69.99</td>
<td>0</td>
</tr>
</tbody>
</table>

<p>5 rows × 31 columns</p>
</div>
</div>
</div>
</section>
<section id="train-validation-test-split" class="level2">
<h2 class="anchored" data-anchor-id="train-validation-test-split">Train-Validation-Test Split</h2>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Splitting the data by target class</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>data_0, data_1 <span class="op">=</span> data[data[<span class="st">'Class'</span>] <span class="op">==</span> <span class="dv">0</span>], data[data[<span class="st">'Class'</span>] <span class="op">==</span> <span class="dv">1</span>]</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Feature-target split</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>X_0, y_0 <span class="op">=</span> data_0.drop(<span class="st">'Class'</span>, axis <span class="op">=</span> <span class="dv">1</span>), data_0[<span class="st">'Class'</span>]</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>X_1, y_1 <span class="op">=</span> data_1.drop(<span class="st">'Class'</span>, axis <span class="op">=</span> <span class="dv">1</span>), data_1[<span class="st">'Class'</span>]</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Splitting the authentic class and constructing the training set</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>X_train, X_test, y_train, y_test <span class="op">=</span> train_test_split(X_0, y_0, test_size <span class="op">=</span> <span class="fl">0.2</span>, random_state <span class="op">=</span> <span class="dv">40</span>)</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>X_val, X_test, y_val, y_test <span class="op">=</span> train_test_split(X_test, y_test, test_size <span class="op">=</span> <span class="fl">0.5</span>, random_state <span class="op">=</span> <span class="dv">40</span>)</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>data_val_1, data_test_1 <span class="op">=</span> pd.concat([X_val, y_val], axis <span class="op">=</span> <span class="dv">1</span>), pd.concat([X_test, y_test], axis <span class="op">=</span> <span class="dv">1</span>)</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Splitting the fraudulent class</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>X_val, X_test, y_val, y_test <span class="op">=</span> train_test_split(X_1, y_1, test_size <span class="op">=</span> <span class="fl">0.5</span>, random_state <span class="op">=</span> <span class="dv">40</span>)</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>data_val_2, data_test_2 <span class="op">=</span> pd.concat([X_val, y_val], axis <span class="op">=</span> <span class="dv">1</span>), pd.concat([X_test, y_test], axis <span class="op">=</span> <span class="dv">1</span>)</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Merging data to construct the validation set and the test set</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>data_val, data_test <span class="op">=</span> pd.concat([data_val_1, data_val_2], axis <span class="op">=</span> <span class="dv">0</span>), pd.concat([data_test_1, data_test_2], axis <span class="op">=</span> <span class="dv">0</span>)</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>X_val, y_val <span class="op">=</span> data_val.drop(<span class="st">'Class'</span>, axis <span class="op">=</span> <span class="dv">1</span>), data_val[<span class="st">'Class'</span>]</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>X_test, y_test <span class="op">=</span> data_test.drop(<span class="st">'Class'</span>, axis <span class="op">=</span> <span class="dv">1</span>), data_test[<span class="st">'Class'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Distribution of authentic and fraudulent transactions over training, validation and test set</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> [<span class="st">'Train'</span>, <span class="st">'Validation'</span>, <span class="st">'Test'</span>]</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>values_0 <span class="op">=</span> [<span class="bu">len</span>(y_train[y_train <span class="op">==</span> <span class="dv">0</span>]), <span class="bu">len</span>(y_val[y_val <span class="op">==</span> <span class="dv">0</span>]), <span class="bu">len</span>(y_test[y_test <span class="op">==</span> <span class="dv">0</span>])]</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>values_1 <span class="op">=</span> [<span class="bu">len</span>(y_train[y_train <span class="op">==</span> <span class="dv">1</span>]), <span class="bu">len</span>(y_val[y_val <span class="op">==</span> <span class="dv">1</span>]), <span class="bu">len</span>(y_test[y_test <span class="op">==</span> <span class="dv">1</span>])]</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> make_subplots(rows <span class="op">=</span> <span class="dv">1</span>, cols <span class="op">=</span> <span class="dv">2</span>, specs <span class="op">=</span> [[{<span class="st">'type'</span>: <span class="st">'domain'</span>}, {<span class="st">'type'</span>: <span class="st">'domain'</span>}]])</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Pie(values <span class="op">=</span> values_0, labels <span class="op">=</span> labels, hole <span class="op">=</span> <span class="fl">0.5</span>, textinfo <span class="op">=</span> <span class="st">'percent'</span>, title <span class="op">=</span> <span class="st">"Authentic"</span>),</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>              row <span class="op">=</span> <span class="dv">1</span>, col <span class="op">=</span> <span class="dv">1</span>)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Pie(values <span class="op">=</span> values_1, labels <span class="op">=</span> labels, hole <span class="op">=</span> <span class="fl">0.5</span>, textinfo <span class="op">=</span> <span class="st">'percent'</span>, title <span class="op">=</span> <span class="st">"Fraudulent"</span>),</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>              row <span class="op">=</span> <span class="dv">1</span>, col <span class="op">=</span> <span class="dv">2</span>)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>text_title <span class="op">=</span> <span class="st">"Distribution of authentic and fraudulent transactions over training, validation and test set"</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>fig.update_layout(height <span class="op">=</span> <span class="dv">500</span>, width <span class="op">=</span> <span class="dv">800</span>, showlegend <span class="op">=</span> <span class="va">True</span>, title <span class="op">=</span> <span class="bu">dict</span>(text <span class="op">=</span> text_title, x <span class="op">=</span> <span class="fl">0.5</span>, y <span class="op">=</span> <span class="fl">0.95</span>)) </span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div>                            <div id="24c51716-c69d-4830-9c87-a4ccf78af469" class="plotly-graph-div" style="height:500px; width:800px;"></div>            <script type="text/javascript">                require(["plotly"], function(Plotly) {                    window.PLOTLYENV=window.PLOTLYENV || {};                                    if (document.getElementById("24c51716-c69d-4830-9c87-a4ccf78af469")) {                    Plotly.newPlot(                        "24c51716-c69d-4830-9c87-a4ccf78af469",                        [{"hole":0.5,"labels":["Train","Validation","Test"],"textinfo":"percent","title":{"text":"Authentic"},"values":[227452,28431,28432],"type":"pie","domain":{"x":[0.0,0.45],"y":[0.0,1.0]}},{"hole":0.5,"labels":["Train","Validation","Test"],"textinfo":"percent","title":{"text":"Fraudulent"},"values":[0,246,246],"type":"pie","domain":{"x":[0.55,1.0],"y":[0.0,1.0]}}],                        {"template":{"data":{"histogram2dcontour":[{"type":"histogram2dcontour","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"choropleth":[{"type":"choropleth","colorbar":{"outlinewidth":0,"ticks":""}}],"histogram2d":[{"type":"histogram2d","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"heatmap":[{"type":"heatmap","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"heatmapgl":[{"type":"heatmapgl","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"contourcarpet":[{"type":"contourcarpet","colorbar":{"outlinewidth":0,"ticks":""}}],"contour":[{"type":"contour","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"surface":[{"type":"surface","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"mesh3d":[{"type":"mesh3d","colorbar":{"outlinewidth":0,"ticks":""}}],"scatter":[{"fillpattern":{"fillmode":"overlay","size":10,"solidity":0.2},"type":"scatter"}],"parcoords":[{"type":"parcoords","line":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterpolargl":[{"type":"scatterpolargl","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"bar":[{"error_x":{"color":"#2a3f5f"},"error_y":{"color":"#2a3f5f"},"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"bar"}],"scattergeo":[{"type":"scattergeo","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterpolar":[{"type":"scatterpolar","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"histogram":[{"marker":{"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"histogram"}],"scattergl":[{"type":"scattergl","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatter3d":[{"type":"scatter3d","line":{"colorbar":{"outlinewidth":0,"ticks":""}},"marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattermapbox":[{"type":"scattermapbox","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterternary":[{"type":"scatterternary","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattercarpet":[{"type":"scattercarpet","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"carpet":[{"aaxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"baxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"type":"carpet"}],"table":[{"cells":{"fill":{"color":"#EBF0F8"},"line":{"color":"white"}},"header":{"fill":{"color":"#C8D4E3"},"line":{"color":"white"}},"type":"table"}],"barpolar":[{"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"barpolar"}],"pie":[{"automargin":true,"type":"pie"}]},"layout":{"autotypenumbers":"strict","colorway":["#636efa","#EF553B","#00cc96","#ab63fa","#FFA15A","#19d3f3","#FF6692","#B6E880","#FF97FF","#FECB52"],"font":{"color":"#2a3f5f"},"hovermode":"closest","hoverlabel":{"align":"left"},"paper_bgcolor":"white","plot_bgcolor":"#E5ECF6","polar":{"bgcolor":"#E5ECF6","angularaxis":{"gridcolor":"white","linecolor":"white","ticks":""},"radialaxis":{"gridcolor":"white","linecolor":"white","ticks":""}},"ternary":{"bgcolor":"#E5ECF6","aaxis":{"gridcolor":"white","linecolor":"white","ticks":""},"baxis":{"gridcolor":"white","linecolor":"white","ticks":""},"caxis":{"gridcolor":"white","linecolor":"white","ticks":""}},"coloraxis":{"colorbar":{"outlinewidth":0,"ticks":""}},"colorscale":{"sequential":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"sequentialminus":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"diverging":[[0,"#8e0152"],[0.1,"#c51b7d"],[0.2,"#de77ae"],[0.3,"#f1b6da"],[0.4,"#fde0ef"],[0.5,"#f7f7f7"],[0.6,"#e6f5d0"],[0.7,"#b8e186"],[0.8,"#7fbc41"],[0.9,"#4d9221"],[1,"#276419"]]},"xaxis":{"gridcolor":"white","linecolor":"white","ticks":"","title":{"standoff":15},"zerolinecolor":"white","automargin":true,"zerolinewidth":2},"yaxis":{"gridcolor":"white","linecolor":"white","ticks":"","title":{"standoff":15},"zerolinecolor":"white","automargin":true,"zerolinewidth":2},"scene":{"xaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2},"yaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2},"zaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2}},"shapedefaults":{"line":{"color":"#2a3f5f"}},"annotationdefaults":{"arrowcolor":"#2a3f5f","arrowhead":0,"arrowwidth":1},"geo":{"bgcolor":"white","landcolor":"#E5ECF6","subunitcolor":"white","showland":true,"showlakes":true,"lakecolor":"white"},"title":{"x":0.05},"mapbox":{"style":"light"}}},"title":{"text":"Distribution of authentic and fraudulent transactions over training, validation and test set","x":0.5,"y":0.95},"height":500,"width":800,"showlegend":true},                        {"responsive": true}                    ).then(function(){
                            
var gd = document.getElementById('24c51716-c69d-4830-9c87-a4ccf78af469');
var x = new MutationObserver(function (mutations, observer) {{
        var display = window.getComputedStyle(gd).display;
        if (!display || display === 'none') {{
            console.log([gd, 'removed!']);
            Plotly.purge(gd);
            observer.disconnect();
        }}
}});

// Listen for the removal of the full notebook cells
var notebookContainer = gd.closest('#notebook-container');
if (notebookContainer) {{
    x.observe(notebookContainer, {childList: true});
}}

// Listen for the clearing of the current output cell
var outputEl = gd.closest('.output');
if (outputEl) {{
    x.observe(outputEl, {childList: true});
}}

                        })                };                });            </script>        </div>
</div>
</div>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Setting the number of bins</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>bins_train <span class="op">=</span> math.floor(<span class="bu">len</span>(X_train)<span class="op">**</span>(<span class="dv">1</span><span class="op">/</span><span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="feature-engineering" class="level2">
<h2 class="anchored" data-anchor-id="feature-engineering">Feature Engineering</h2>
<section id="time" class="level3">
<h3 class="anchored" data-anchor-id="time">Time</h3>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Decomposing time</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> df <span class="kw">in</span> [X_train, X_val, X_test]:</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'Day'</span>], temp <span class="op">=</span> df[<span class="st">'Time'</span>] <span class="op">//</span> (<span class="dv">24</span><span class="op">*</span><span class="dv">60</span><span class="op">*</span><span class="dv">60</span>), df[<span class="st">'Time'</span>] <span class="op">%</span> (<span class="dv">24</span><span class="op">*</span><span class="dv">60</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'Hour'</span>], temp <span class="op">=</span> temp <span class="op">//</span> (<span class="dv">60</span><span class="op">*</span><span class="dv">60</span>), temp <span class="op">%</span> (<span class="dv">60</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'Minute'</span>], df[<span class="st">'Second'</span>] <span class="op">=</span> temp <span class="op">//</span> <span class="dv">60</span>, temp <span class="op">%</span> <span class="dv">60</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>X_train[[<span class="st">'Time'</span>, <span class="st">'Day'</span>, <span class="st">'Hour'</span>, <span class="st">'Minute'</span>, <span class="st">'Second'</span>]].head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Time</th>
<th data-quarto-table-cell-role="th">Day</th>
<th data-quarto-table-cell-role="th">Hour</th>
<th data-quarto-table-cell-role="th">Minute</th>
<th data-quarto-table-cell-role="th">Second</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">19594</td>
<td>30401.0</td>
<td>0.0</td>
<td>8.0</td>
<td>26.0</td>
<td>41.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">124712</td>
<td>77397.0</td>
<td>0.0</td>
<td>21.0</td>
<td>29.0</td>
<td>57.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">167920</td>
<td>118964.0</td>
<td>1.0</td>
<td>9.0</td>
<td>2.0</td>
<td>44.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">47377</td>
<td>43191.0</td>
<td>0.0</td>
<td>11.0</td>
<td>59.0</td>
<td>51.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">41731</td>
<td>40804.0</td>
<td>0.0</td>
<td>11.0</td>
<td>20.0</td>
<td>4.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualization</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize <span class="op">=</span> (<span class="dv">15</span>, <span class="dv">6</span>), sharey <span class="op">=</span> <span class="va">False</span>)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>sns.histplot(data <span class="op">=</span> X_train, x <span class="op">=</span> <span class="st">'Time'</span>, bins <span class="op">=</span> bins_train, ax <span class="op">=</span> ax[<span class="dv">0</span>])</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>sns.histplot(data <span class="op">=</span> X_train, x <span class="op">=</span> <span class="st">'Hour'</span>, bins <span class="op">=</span> <span class="dv">24</span>, ax <span class="op">=</span> ax[<span class="dv">1</span>])</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].set_ylabel(<span class="st">" "</span>)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>plt.suptitle(<span class="st">"Histograms of Time and Hour"</span>, size <span class="op">=</span> <span class="dv">14</span>)</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-9-output-1.png" width="1424" height="566"></p>
</div>
</div>
</section>
</section>
<section id="amount" class="level2">
<h2 class="anchored" data-anchor-id="amount">Amount</h2>
<p>The distribution of Amount has extreme positive skewness. We apply the transformation x↦log(x+0.001) to this column and form the new column Amount_transformed. The positive constant 0.001 is added to deal with the zero-amount transactions, which leads to log 0, an undefined quantity.</p>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Transformation of 'Amount'</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> df <span class="kw">in</span> [X_train, X_val, X_test]:</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'Amount_transformed'</span>] <span class="op">=</span> np.log10(df[<span class="st">'Amount'</span>] <span class="op">+</span> <span class="fl">0.001</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualization</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize <span class="op">=</span> (<span class="dv">15</span>, <span class="dv">6</span>), sharey <span class="op">=</span> <span class="va">False</span>)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>sns.histplot(data <span class="op">=</span> X_train, x <span class="op">=</span> <span class="st">'Amount'</span>, bins <span class="op">=</span> bins_train, ax <span class="op">=</span> ax[<span class="dv">0</span>])</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>sns.histplot(data <span class="op">=</span> X_train, x <span class="op">=</span> <span class="st">'Amount_transformed'</span>, bins <span class="op">=</span> bins_train, ax <span class="op">=</span> ax[<span class="dv">1</span>])</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].set_ylabel(<span class="st">" "</span>)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>plt.suptitle(<span class="st">"Histograms of Amount and Amount_transformed"</span>, size <span class="op">=</span> <span class="dv">14</span>)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-11-output-1.png" width="1425" height="566"></p>
</div>
</div>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Discarding unnecessary columns</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> df <span class="kw">in</span> [X_train, X_val, X_test]:</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    df.drop([<span class="st">'Time'</span>, <span class="st">'Day'</span>, <span class="st">'Minute'</span>, <span class="st">'Second'</span>, <span class="st">'Amount'</span>], axis <span class="op">=</span> <span class="dv">1</span>, inplace <span class="op">=</span> <span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="feature-selection" class="level1">
<h1>Feature Selection</h1>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Comparison of feature distributions for different target classes</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>data_val <span class="op">=</span> pd.concat([X_val, y_val], axis <span class="op">=</span> <span class="dv">1</span>)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>data_val_0, data_val_1 <span class="op">=</span> data_val[data_val[<span class="st">'Class'</span>] <span class="op">==</span> <span class="dv">0</span>], data_val[data_val[<span class="st">'Class'</span>] <span class="op">==</span> <span class="dv">1</span>]</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>cols, ncols <span class="op">=</span> <span class="bu">list</span>(X_val.columns), <span class="dv">3</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>nrows <span class="op">=</span> math.ceil(<span class="bu">len</span>(cols) <span class="op">/</span> ncols)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(nrows, ncols, figsize <span class="op">=</span> (<span class="fl">4.5</span> <span class="op">*</span> ncols, <span class="dv">4</span> <span class="op">*</span> nrows))</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(cols)):</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    sns.kdeplot(data_val_0[cols[i]], ax <span class="op">=</span> ax[i <span class="op">//</span> ncols, i <span class="op">%</span> ncols])</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    sns.kdeplot(data_val_1[cols[i]], ax <span class="op">=</span> ax[i <span class="op">//</span> ncols, i <span class="op">%</span> ncols])</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> i <span class="op">%</span> ncols <span class="op">!=</span> <span class="dv">0</span>:</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>        ax[i <span class="op">//</span> ncols, i <span class="op">%</span> ncols].set_ylabel(<span class="st">" "</span>)</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-13-output-1.png" width="1280" height="3824"></p>
</div>
</div>
<div class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Feature selection</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>cols <span class="op">=</span> [<span class="st">'V4'</span>, <span class="st">'V11'</span>, <span class="st">'V12'</span>, <span class="st">'V14'</span>, <span class="st">'V16'</span>, <span class="st">'V17'</span>, <span class="st">'V18'</span>, <span class="st">'V19'</span>, <span class="st">'Hour'</span>]</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>X_train_fs, X_val_fs, X_test_fs <span class="op">=</span> X_train[cols], X_val[cols], X_test[cols]</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>X_train_fs.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">V4</th>
<th data-quarto-table-cell-role="th">V11</th>
<th data-quarto-table-cell-role="th">V12</th>
<th data-quarto-table-cell-role="th">V14</th>
<th data-quarto-table-cell-role="th">V16</th>
<th data-quarto-table-cell-role="th">V17</th>
<th data-quarto-table-cell-role="th">V18</th>
<th data-quarto-table-cell-role="th">V19</th>
<th data-quarto-table-cell-role="th">Hour</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">19594</td>
<td>-0.706232</td>
<td>2.027925</td>
<td>0.535822</td>
<td>0.250769</td>
<td>0.773615</td>
<td>0.449717</td>
<td>-1.963208</td>
<td>0.613481</td>
<td>8.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">124712</td>
<td>1.474933</td>
<td>-1.154523</td>
<td>0.263527</td>
<td>0.316174</td>
<td>-1.029415</td>
<td>1.030772</td>
<td>-0.438839</td>
<td>0.529080</td>
<td>21.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">167920</td>
<td>4.840766</td>
<td>-2.242431</td>
<td>0.034829</td>
<td>-0.546349</td>
<td>-0.070375</td>
<td>1.033695</td>
<td>0.531801</td>
<td>1.215045</td>
<td>9.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">47377</td>
<td>0.565273</td>
<td>-0.157045</td>
<td>-0.548790</td>
<td>0.419194</td>
<td>0.183518</td>
<td>-0.681323</td>
<td>0.911357</td>
<td>1.318132</td>
<td>11.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">41731</td>
<td>-0.428860</td>
<td>-0.580964</td>
<td>-0.609099</td>
<td>-0.187948</td>
<td>1.226723</td>
<td>0.104368</td>
<td>-0.995711</td>
<td>0.420557</td>
<td>11.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<section id="implementing-anomaly-detection" class="level2">
<h2 class="anchored" data-anchor-id="implementing-anomaly-detection">Implementing Anomaly Detection</h2>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Normal pdf</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> normal_density(x, mu, sigma):</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Computes univariate normal probability density function (pdf) with mean mu, standard deviation sigma</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="co">      x (scalar)    : input observation</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="co">      mu (scalar)   : mean</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="co">      sigma (scalar): standard deviation (&gt; 0)</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="co">      f (scalar): value of the univariate normal pdf</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> sigma <span class="op">&gt;</span> <span class="dv">0</span>, <span class="st">"Standard deviation must be positive"</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>    f <span class="op">=</span> (<span class="dv">1</span> <span class="op">/</span> (sigma <span class="op">*</span> np.sqrt(<span class="dv">2</span> <span class="op">*</span> np.pi))) <span class="op">*</span> np.exp(<span class="op">-</span> (<span class="dv">1</span> <span class="op">/</span> <span class="dv">2</span>) <span class="op">*</span> ((x <span class="op">-</span> mu) <span class="op">/</span> sigma)<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> f</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Product of normal pdfs</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> normal_product(x_vec, mu_vec, sigma_vec):</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Computes product of univariate normal densities</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="co">      x_vec (array_like, shape (n,))    : vector of input observations</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="co">      mu_vec (array_like, shape (n,))   : vector of means</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="co">      sigma_vec (array_like, shape (n,)): vector of standard deviations (&gt; 0)</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="co">      f (scalar): product of univariate normal densities</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="bu">min</span>(sigma_vec) <span class="op">&gt;</span> <span class="dv">0</span>, <span class="st">"Standard deviation must be positive"</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="bu">len</span>(mu_vec) <span class="op">==</span> <span class="bu">len</span>(x_vec), <span class="st">"Length of mean vector does not match length of input vector"</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="bu">len</span>(sigma_vec) <span class="op">==</span> <span class="bu">len</span>(x_vec), <span class="st">"Length of standard deviation vector does not match length of input vector"</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>    f <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(x_vec)):</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>        f <span class="op">=</span> f <span class="op">*</span> normal_density(x_vec[i], mu_vec[i], sigma_vec[i])</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> f</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next, we compute the vector of means and vector of standard deviations for the features in the training set. These estimates characterize the joint probability density function of the features, which will be used to detect anomalous observations.</p>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Model fitting</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>mu_train, sigma_train <span class="op">=</span> X_train_fs.mean(), X_train_fs.std()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to predict anomaly based on probability density threshold</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> model_normal(X, epsilon):</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Anomaly detection model</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="co">      X (DataFrame, shape (m, n)): DataFrame of features</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="co">      epsilon (scalar)           : threshold density value (&gt; 0)</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="co">      y (array_like, shape (m,)): predicted class labels</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> []</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> X.index:</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>        prob_density <span class="op">=</span> normal_product(X.loc[i].tolist(), mu_train, sigma_train)</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>        y.append((prob_density <span class="op">&lt;</span> epsilon).astype(<span class="bu">int</span>))</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> y</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="threshold-tuning-on-validation-set" class="level2">
<h2 class="anchored" data-anchor-id="threshold-tuning-on-validation-set">Threshold Tuning on Validation Set</h2>
<p>First, we construct some functions to compute and display the confusion matrix and to compute the F2-score, given the true labels and the predicted labels of the target.</p>
<div class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to compute confusion matrix</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> conf_mat(y_test, y_pred):</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Computes confusion matrix</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="co">      y_test (array_like): true binary (0 or 1) labels</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="co">      y_pred (array_like): predicted binary (0 or 1) labels</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="co">      confusion_mat (array): A 2D array representing a 2x2 confusion matrix</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    y_test, y_pred <span class="op">=</span> <span class="bu">list</span>(y_test), <span class="bu">list</span>(y_pred)</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    count, labels, confusion_mat <span class="op">=</span> <span class="bu">len</span>(y_test), [<span class="dv">0</span>, <span class="dv">1</span>], np.zeros(shape <span class="op">=</span> (<span class="dv">2</span>, <span class="dv">2</span>), dtype <span class="op">=</span> <span class="bu">int</span>)</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">2</span>):</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">2</span>):</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>            confusion_mat[i][j] <span class="op">=</span> <span class="bu">len</span>([k <span class="cf">for</span> k <span class="kw">in</span> <span class="bu">range</span>(count) <span class="cf">if</span> y_test[k] <span class="op">==</span> labels[i] <span class="kw">and</span> y_pred[k] <span class="op">==</span> labels[j]])</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> confusion_mat</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to print confusion matrix</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> conf_mat_heatmap(y_test, y_pred):</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Prints confusion matrix</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="co">      y_test (array_like): true binary (0 or 1) labels</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="co">      y_pred (array_like): predicted binary (0 or 1) labels</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="co">      Nothing, prints a heatmap representing a 2x2 confusion matrix</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>    confusion_mat <span class="op">=</span> conf_mat(y_test, y_pred)</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>    labels, confusion_mat_df <span class="op">=</span> [<span class="dv">0</span>, <span class="dv">1</span>], pd.DataFrame(confusion_mat, <span class="bu">range</span>(<span class="dv">2</span>), <span class="bu">range</span>(<span class="dv">2</span>))</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize <span class="op">=</span> (<span class="dv">6</span>, <span class="fl">4.75</span>))</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>    sns.heatmap(confusion_mat_df, annot <span class="op">=</span> <span class="va">True</span>, annot_kws <span class="op">=</span> {<span class="st">"size"</span>: <span class="dv">16</span>}, fmt <span class="op">=</span> <span class="st">'d'</span>)</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>    plt.xticks([<span class="fl">0.5</span>, <span class="fl">1.5</span>], labels, rotation <span class="op">=</span> <span class="st">'horizontal'</span>)</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>    plt.yticks([<span class="fl">0.5</span>, <span class="fl">1.5</span>], labels, rotation <span class="op">=</span> <span class="st">'horizontal'</span>)</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">"Predicted label"</span>, fontsize <span class="op">=</span> <span class="dv">14</span>)</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">"True label"</span>, fontsize <span class="op">=</span> <span class="dv">14</span>)</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="st">"Confusion Matrix"</span>, fontsize <span class="op">=</span> <span class="dv">14</span>)</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>    plt.grid(<span class="va">False</span>)</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>    plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to compute and return f2_score</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> f2_score(y_test, y_pred):</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Computes accuracy, given true and predicted binary (0 or 1) labels</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="co">      y_test (array_like): true binary (0 or 1) labels</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="co">      y_pred (array_like): predicted binary (0 or 1) labels</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="co">      f2 (float): accuracy obtained from y_test and y_pred</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    confusion_mat <span class="op">=</span> conf_mat(y_test, y_pred)</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    tn, fp, fn, tp <span class="op">=</span> confusion_mat[<span class="dv">0</span>, <span class="dv">0</span>], confusion_mat[<span class="dv">0</span>, <span class="dv">1</span>], confusion_mat[<span class="dv">1</span>, <span class="dv">0</span>], confusion_mat[<span class="dv">1</span>, <span class="dv">1</span>]</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>    f2 <span class="op">=</span> (<span class="dv">5</span> <span class="op">*</span> tp) <span class="op">/</span> ((<span class="dv">5</span> <span class="op">*</span> tp) <span class="op">+</span> (<span class="dv">4</span> <span class="op">*</span> fn) <span class="op">+</span> fp)</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> f2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Tuning the threshold of density value</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>alpha_list, f2_list, f2_max, alpha_opt, y_val_pred_opt <span class="op">=</span> [], [], <span class="fl">0.0</span>, <span class="fl">0.0</span>, np.zeros(<span class="bu">len</span>(y_val))</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> alpha, j <span class="kw">in</span> itertools.product(np.arange(<span class="fl">0.001</span>, <span class="fl">0.051</span>, <span class="fl">0.001</span>), <span class="bu">range</span>(<span class="dv">1</span>)):</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    y_val_pred <span class="op">=</span> model_normal(X_val_fs, epsilon <span class="op">=</span> alpha<span class="op">**</span>X_val_fs.shape[<span class="dv">1</span>])</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    f2 <span class="op">=</span> f2_score(y_val, y_val_pred)</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    alpha_list.append(alpha)</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    f2_list.append(f2)</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> f2 <span class="op">&gt;</span> f2_max:</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>        alpha_opt <span class="op">=</span> alpha</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>        y_val_pred_opt <span class="op">=</span> y_val_pred</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>        f2_max <span class="op">=</span> f2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"e298556207244c728ca9faf10920626e","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>C:\Users\Lenovo\AppData\Local\Temp\ipykernel_47740\516892871.py:17: FutureWarning:

Series.__getitem__ treating keys as positions is deprecated. In a future version, integer keys will always be treated as labels (consistent with DataFrame behavior). To access a value by position, use `ser.iloc[pos]`
</code></pre>
</div>
</div>
<div class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plotting F2-score over alpha</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize <span class="op">=</span> (<span class="dv">9</span>, <span class="dv">6</span>))</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>plt.plot(alpha_list, f2_list)</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"alpha"</span>, fontsize <span class="op">=</span> <span class="dv">14</span>)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"F2-score"</span>, fontsize <span class="op">=</span> <span class="dv">14</span>)</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"F2-score vs alpha"</span>, fontsize <span class="op">=</span> <span class="dv">14</span>)</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-23-output-1.png" width="848" height="559"></p>
</div>
</div>
<div class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Tuning summary</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(pd.Series({</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Optimal alpha"</span>: alpha_opt,</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Optimal F2-score"</span>: f2_score(y_val, y_val_pred_opt)</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>}).to_string())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Optimal alpha       0.009000
Optimal F2-score    0.834671</code></pre>
</div>
</div>
<div class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Confusion matrix for predictions on the validation set</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>conf_mat_heatmap(y_val, y_val_pred_opt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-25-output-1.png" width="513" height="441"></p>
</div>
</div>
</section>
<section id="prediction-and-evaluation-on-test-set" class="level2">
<h2 class="anchored" data-anchor-id="prediction-and-evaluation-on-test-set">Prediction and Evaluation on Test Set</h2>
<div class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to compute and print evaluation metrics</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> evaluation(y_test, y_pred):</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    confusion_mat <span class="op">=</span> conf_mat(y_test, y_pred)</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    tn, fp, fn, tp <span class="op">=</span> confusion_mat[<span class="dv">0</span>, <span class="dv">0</span>], confusion_mat[<span class="dv">0</span>, <span class="dv">1</span>], confusion_mat[<span class="dv">1</span>, <span class="dv">0</span>], confusion_mat[<span class="dv">1</span>, <span class="dv">1</span>]</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(pd.Series({</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Accuracy"</span>: (tp <span class="op">+</span> tn) <span class="op">/</span> (tn <span class="op">+</span> fp <span class="op">+</span> fn <span class="op">+</span> tp),</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Precision"</span>: tp <span class="op">/</span> (tp <span class="op">+</span> fp),</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Recall"</span>: tp <span class="op">/</span> (tp <span class="op">+</span> fn),</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"F1-score"</span>: (<span class="dv">2</span> <span class="op">*</span> tp) <span class="op">/</span> ((<span class="dv">2</span> <span class="op">*</span> tp) <span class="op">+</span> fn <span class="op">+</span> fp),</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"F2-score"</span>: (<span class="dv">5</span> <span class="op">*</span> tp) <span class="op">/</span> ((<span class="dv">5</span> <span class="op">*</span> tp) <span class="op">+</span> (<span class="dv">4</span> <span class="op">*</span> fn) <span class="op">+</span> fp),</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">"MCC"</span>: ((tp <span class="op">*</span> tn) <span class="op">-</span> (fp <span class="op">*</span> fn)) <span class="op">/</span> np.sqrt((tp <span class="op">+</span> fp) <span class="op">*</span> (tp <span class="op">+</span> fn) <span class="op">*</span> (tn <span class="op">+</span> fp) <span class="op">*</span> (tn <span class="op">+</span> fn))</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>    }).to_string())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Prediction and evaluation on the test set</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>y_test_normal <span class="op">=</span> model_normal(X_test_fs, epsilon <span class="op">=</span> alpha_opt<span class="op">**</span>X_test_fs.shape[<span class="dv">1</span>])</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>evaluation(y_test, y_test_normal)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>C:\Users\Lenovo\AppData\Local\Temp\ipykernel_47740\516892871.py:17: FutureWarning:

Series.__getitem__ treating keys as positions is deprecated. In a future version, integer keys will always be treated as labels (consistent with DataFrame behavior). To access a value by position, use `ser.iloc[pos]`

C:\Users\Lenovo\AppData\Local\Temp\ipykernel_47740\2892512474.py:11: RuntimeWarning:

overflow encountered in scalar multiply
</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Accuracy       0.996687
Precision      0.798419
Recall         0.821138
F1-score       0.809619
F2-score       0.816492
MCC          171.242437</code></pre>
</div>
</div>
<div class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Confusion matrix for predictions on the test set</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>conf_mat_heatmap(y_test, y_test_normal)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-28-output-1.png" width="513" height="441"></p>
</div>
</div>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>Here, we addressed the challenge of a highly imbalanced dataset in credit card transactions, where fraudulent transactions are significantly less frequent compared to legitimate ones. The approach involved sophisticated feature engineering, where we extracted ‘Hour’ from the ‘Time’ attribute and log-transformed the ‘Amount’ feature to correct for skewness, resulting in a new feature called ‘Amount_transformed’.</p>
<p>A crucial step in the analysis was the selection of key features that show distinct distribution patterns across the two classes of transactions. Out of 30 features engineered, 9 (V4, V11, V12, V14, V16, V17, V18, V19, and Hour) were identified as significantly influential in distinguishing between fraudulent and legitimate transactions. These features were used to fit a multivariate normal distribution to the training data, under the assumption of statistical independence among features, a reasonable assumption given that most of the features were obtained through PCA.</p>
<p>The final phase of the project involved optimizing a threshold for anomaly detection. This was achieved by iterating over a range of values and evaluating their performance using the F2-score on the validation set. The optimal threshold was found to be approximately 0.0099. With this threshold, the model achieved an F2-score of 0.834671 on the validation set. When applied to the test set, the model demonstrated a consistent performance with an F2-score of 0.816492. This method proved effective in flagging transactions as fraudulent based on their density values in the fitted distribution.</p>


<!-- -->

</section>
</section>

</main> <!-- /main -->
<script type="application/vnd.jupyter.widget-state+json">
{"state":{"02153720c11a4617b2ddc3774e5db5ec":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"ProgressStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"ProgressStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","bar_color":null,"description_width":""}},"112ee470c70842fd8bcbb3c2762b1bbc":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"13e32bdcb2c14cba8f696109982de5bc":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"FloatProgressModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"FloatProgressModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"ProgressView","bar_style":"success","description":"","description_allow_html":false,"layout":"IPY_MODEL_69c95089bc42455eab2f875ce7d4311d","max":50,"min":0,"orientation":"horizontal","style":"IPY_MODEL_02153720c11a4617b2ddc3774e5db5ec","tabbable":null,"tooltip":null,"value":50}},"69c95089bc42455eab2f875ce7d4311d":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"839d38b402eb4dc792f9b8d3d8bc1a52":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"8d645e0ed05140cfbd7df2cf81765cc4":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HTMLView","description":"","description_allow_html":false,"layout":"IPY_MODEL_c4799843e65448ff9606baa656c5a286","placeholder":"​","style":"IPY_MODEL_d47a49af64194d908b53c51bb2650433","tabbable":null,"tooltip":null,"value":" 50/50 [04:41&lt;00:00,  5.69s/it]"}},"bd213a7ecb4d49d89d68603536c361dc":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HTMLView","description":"","description_allow_html":false,"layout":"IPY_MODEL_839d38b402eb4dc792f9b8d3d8bc1a52","placeholder":"​","style":"IPY_MODEL_c39e1fa13d794c4ca478208ca216a1cc","tabbable":null,"tooltip":null,"value":"100%"}},"c39e1fa13d794c4ca478208ca216a1cc":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","background":null,"description_width":"","font_size":null,"text_color":null}},"c4799843e65448ff9606baa656c5a286":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"d47a49af64194d908b53c51bb2650433":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","background":null,"description_width":"","font_size":null,"text_color":null}},"e298556207244c728ca9faf10920626e":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HBoxModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HBoxModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HBoxView","box_style":"","children":["IPY_MODEL_bd213a7ecb4d49d89d68603536c361dc","IPY_MODEL_13e32bdcb2c14cba8f696109982de5bc","IPY_MODEL_8d645e0ed05140cfbd7df2cf81765cc4"],"layout":"IPY_MODEL_112ee470c70842fd8bcbb3c2762b1bbc","tabbable":null,"tooltip":null}}},"version_major":2,"version_minor":0}
</script>
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb33" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Anomaly/Outlier detection"</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> "Samheeta"</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> "2023-12-6"</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="an">jupyter:</span><span class="co"> python3</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="an">description:</span><span class="co"> "Anomaly detection in Machine Learning focuses on identifying rare or unusual instances in data that significantly differ from the majority of normal observations, aiding in the detection of outliers or irregular patterns."</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>**Contents:**</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Introduction to Anomaly or Outlier Detection.</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Example of Anomaly Detection with real data <span class="co">[</span><span class="ot">Credit Card dataset</span><span class="co">](https://www.kaggle.com/datasets/mlg-ulb/creditcardfraud)</span> </span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Data Visualization</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Data processing</span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Anomaly Detection</span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a><span class="fu">#### **Anomaly or Outlier Detection**</span></span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>Anomaly or outlier detection is a crucial aspect of data analysis and machine learning, involving the identification of data points or observations that deviate significantly from the expected or normal behavior within a dataset. These anomalies, often representing rare events, errors, or unusual patterns, are detected using various techniques such as statistical methods, machine learning algorithms, distance-based approaches, and domain-specific rules, enabling their recognition in applications like fraud detection, quality control, network security, and predictive maintenance, ultimately enhancing decision-making and problem-solving in diverse fields.</span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>In the context of machine learning, anomaly detection can be approached using various techniques and algorithms, including:</span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Statistical Methods: Statistical approaches involve using statistical measures such as mean, standard deviation, and probability distributions to identify outliers. Data points that fall outside predefined statistical thresholds are considered anomalies.</span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Machine Learning Algorithms: Machine learning models can be trained to detect anomalies. Some popular algorithms for this purpose include:</span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a>One-Class SVM (Support Vector Machine): It is a supervised learning algorithm that learns to classify data points as either "normal" or "anomalous" based on the majority class (usually "normal" data).</span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-33"><a href="#cb33-33" aria-hidden="true" tabindex="-1"></a>Isolation Forest: This algorithm isolates anomalies by recursively partitioning the data into subsets, making it efficient for high-dimensional datasets.</span>
<span id="cb33-34"><a href="#cb33-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-35"><a href="#cb33-35" aria-hidden="true" tabindex="-1"></a>Autoencoders: These neural networks are used for unsupervised learning and can learn to reconstruct normal data. Data points that are poorly reconstructed are considered anomalies.</span>
<span id="cb33-36"><a href="#cb33-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-37"><a href="#cb33-37" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Distance-Based Methods: These methods compute distances or dissimilarities between data points and identify outliers as those with unusually large distances from their nearest neighbors. k-nearest neighbors (KNN) and DBSCAN (Density-Based Spatial Clustering of Applications with Noise) are examples of distance-based techniques.</span>
<span id="cb33-38"><a href="#cb33-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-39"><a href="#cb33-39" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Time Series Anomaly Detection: In time series data, specialized methods like Seasonal Decomposition of Time Series (STL), Exponential Smoothing, or Recurrent Neural Networks (RNNs) can be used to detect anomalies over time.</span>
<span id="cb33-40"><a href="#cb33-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-41"><a href="#cb33-41" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Rule-Based Systems: Domain-specific knowledge can be applied to define rules that identify anomalies based on specific criteria. This approach is often used in fields like cybersecurity.</span>
<span id="cb33-42"><a href="#cb33-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-43"><a href="#cb33-43" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Unsupervised and Semi-Supervised Learning: Anomaly detection can be performed in an unsupervised manner, where the model learns from data without the need for labeled anomalies, or in a semi-supervised manner with a limited amount of labeled data.</span>
<span id="cb33-44"><a href="#cb33-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-45"><a href="#cb33-45" aria-hidden="true" tabindex="-1"></a>The choice of method depends on the characteristics of the data, the specific problem, and the available resources. Anomaly detection is a valuable tool in machine learning for uncovering irregularities and potential issues within datasets, leading to improved decision-making and problem-solving in various domains.</span>
<span id="cb33-46"><a href="#cb33-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-47"><a href="#cb33-47" aria-hidden="true" tabindex="-1"></a><span class="fu">## Importing libraries</span></span>
<span id="cb33-48"><a href="#cb33-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-51"><a href="#cb33-51" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb33-52"><a href="#cb33-52" aria-hidden="true" tabindex="-1"></a><span class="co"># File system manangement</span></span>
<span id="cb33-53"><a href="#cb33-53" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time, psutil, os, gc</span>
<span id="cb33-54"><a href="#cb33-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-55"><a href="#cb33-55" aria-hidden="true" tabindex="-1"></a><span class="co"># Mathematical functions</span></span>
<span id="cb33-56"><a href="#cb33-56" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> math</span>
<span id="cb33-57"><a href="#cb33-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-58"><a href="#cb33-58" aria-hidden="true" tabindex="-1"></a><span class="co"># Data manipulation</span></span>
<span id="cb33-59"><a href="#cb33-59" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb33-60"><a href="#cb33-60" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb33-61"><a href="#cb33-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-62"><a href="#cb33-62" aria-hidden="true" tabindex="-1"></a><span class="co"># Plotting and visualization</span></span>
<span id="cb33-63"><a href="#cb33-63" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb33-64"><a href="#cb33-64" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.patches <span class="im">as</span> mpatches</span>
<span id="cb33-65"><a href="#cb33-65" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb33-66"><a href="#cb33-66" aria-hidden="true" tabindex="-1"></a>sns.set_theme()</span>
<span id="cb33-67"><a href="#cb33-67" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.express <span class="im">as</span> px</span>
<span id="cb33-68"><a href="#cb33-68" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.graph_objects <span class="im">as</span> go</span>
<span id="cb33-69"><a href="#cb33-69" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> plotly.subplots <span class="im">import</span> make_subplots</span>
<span id="cb33-70"><a href="#cb33-70" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> plotly.offline <span class="im">import</span> init_notebook_mode, iplot</span>
<span id="cb33-71"><a href="#cb33-71" aria-hidden="true" tabindex="-1"></a>init_notebook_mode(connected<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb33-72"><a href="#cb33-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-73"><a href="#cb33-73" aria-hidden="true" tabindex="-1"></a><span class="co"># Train-test split</span></span>
<span id="cb33-74"><a href="#cb33-74" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb33-75"><a href="#cb33-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-76"><a href="#cb33-76" aria-hidden="true" tabindex="-1"></a><span class="co"># Progress bar for loop</span></span>
<span id="cb33-77"><a href="#cb33-77" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm.contrib <span class="im">import</span> itertools</span>
<span id="cb33-78"><a href="#cb33-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-79"><a href="#cb33-79" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-80"><a href="#cb33-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-81"><a href="#cb33-81" aria-hidden="true" tabindex="-1"></a><span class="fu">## Runtime and memory usage</span></span>
<span id="cb33-82"><a href="#cb33-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-85"><a href="#cb33-85" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb33-86"><a href="#cb33-86" aria-hidden="true" tabindex="-1"></a><span class="co"># Recording the starting time, complemented with a stopping time check in the end to compute process runtime</span></span>
<span id="cb33-87"><a href="#cb33-87" aria-hidden="true" tabindex="-1"></a>start <span class="op">=</span> time.time()</span>
<span id="cb33-88"><a href="#cb33-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-89"><a href="#cb33-89" aria-hidden="true" tabindex="-1"></a><span class="co"># Class representing the OS process and having memory_info() method to compute process memory usage</span></span>
<span id="cb33-90"><a href="#cb33-90" aria-hidden="true" tabindex="-1"></a>process <span class="op">=</span> psutil.Process(os.getpid())</span>
<span id="cb33-91"><a href="#cb33-91" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-92"><a href="#cb33-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-93"><a href="#cb33-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-94"><a href="#cb33-94" aria-hidden="true" tabindex="-1"></a>The Anomaly Detection in credit card transactions is aiming to identify fraudulent transactions among a highly imbalanced dataset. Anomalies, or outliers, are rare observations that deviate significantly from the majority of data points. Anomaly detection techniques, including machine learning, are employed to automate this process. The project's objective is to fit a probability distribution based on authentic transactions and use it to identify new transactions as authentic or fraudulent, with the target variable playing no role in constructing the distribution.</span>
<span id="cb33-95"><a href="#cb33-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-96"><a href="#cb33-96" aria-hidden="true" tabindex="-1"></a>The evaluation metric considers True Positives (correctly predicting positive outcomes), True Negatives (correctly predicting negative outcomes), False Positives (incorrectly predicting positive outcomes), and False Negatives (incorrectly predicting negative outcomes). Metrics like Precision, Recall, F1-Score, and MCC are used to evaluate model performance. F2-Score is given special importance due to the higher cost associated with false negatives in this context.</span>
<span id="cb33-97"><a href="#cb33-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-98"><a href="#cb33-98" aria-hidden="true" tabindex="-1"></a>Feature selection is crucial due to high dimensionality, with 30 features in the dataset. Features are selected based on their ability to distinguish between authentic and fraudulent transactions, considering the distributions of each feature for both target classes. Features exhibiting distinct distributions are retained for classification purposes.</span>
<span id="cb33-99"><a href="#cb33-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-100"><a href="#cb33-100" aria-hidden="true" tabindex="-1"></a>The dataset contains information on credit card transactions made by European cardholders and can be accessed via Kaggle. The data includes transaction time, PCA-transformed features (V1 to V28), transaction amount, and a binary class variable indicating authenticity (0 for authentic, 1 for fraudulent).</span>
<span id="cb33-101"><a href="#cb33-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-104"><a href="#cb33-104" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb33-105"><a href="#cb33-105" aria-hidden="true" tabindex="-1"></a><span class="co"># Loading the data</span></span>
<span id="cb33-106"><a href="#cb33-106" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> pd.read_csv(<span class="st">'C:/Users/Lenovo/Desktop/MLBlog-gh-pages/posts/anomaly-detection/creditcard.csv'</span>)</span>
<span id="cb33-107"><a href="#cb33-107" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(pd.Series({<span class="st">"Memory usage"</span>: <span class="st">"</span><span class="sc">{:.2f}</span><span class="st"> MB"</span>.<span class="bu">format</span>(data.memory_usage().<span class="bu">sum</span>()<span class="op">/</span>(<span class="dv">1024</span><span class="op">*</span><span class="dv">1024</span>)),</span>
<span id="cb33-108"><a href="#cb33-108" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"Dataset shape"</span>: <span class="st">"</span><span class="sc">{}</span><span class="st">"</span>.<span class="bu">format</span>(data.shape)}).to_string())</span>
<span id="cb33-109"><a href="#cb33-109" aria-hidden="true" tabindex="-1"></a>data.head()</span>
<span id="cb33-110"><a href="#cb33-110" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-111"><a href="#cb33-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-112"><a href="#cb33-112" aria-hidden="true" tabindex="-1"></a><span class="fu">## Train-Validation-Test Split</span></span>
<span id="cb33-113"><a href="#cb33-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-116"><a href="#cb33-116" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb33-117"><a href="#cb33-117" aria-hidden="true" tabindex="-1"></a><span class="co"># Splitting the data by target class</span></span>
<span id="cb33-118"><a href="#cb33-118" aria-hidden="true" tabindex="-1"></a>data_0, data_1 <span class="op">=</span> data[data[<span class="st">'Class'</span>] <span class="op">==</span> <span class="dv">0</span>], data[data[<span class="st">'Class'</span>] <span class="op">==</span> <span class="dv">1</span>]</span>
<span id="cb33-119"><a href="#cb33-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-120"><a href="#cb33-120" aria-hidden="true" tabindex="-1"></a><span class="co"># Feature-target split</span></span>
<span id="cb33-121"><a href="#cb33-121" aria-hidden="true" tabindex="-1"></a>X_0, y_0 <span class="op">=</span> data_0.drop(<span class="st">'Class'</span>, axis <span class="op">=</span> <span class="dv">1</span>), data_0[<span class="st">'Class'</span>]</span>
<span id="cb33-122"><a href="#cb33-122" aria-hidden="true" tabindex="-1"></a>X_1, y_1 <span class="op">=</span> data_1.drop(<span class="st">'Class'</span>, axis <span class="op">=</span> <span class="dv">1</span>), data_1[<span class="st">'Class'</span>]</span>
<span id="cb33-123"><a href="#cb33-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-124"><a href="#cb33-124" aria-hidden="true" tabindex="-1"></a><span class="co"># Splitting the authentic class and constructing the training set</span></span>
<span id="cb33-125"><a href="#cb33-125" aria-hidden="true" tabindex="-1"></a>X_train, X_test, y_train, y_test <span class="op">=</span> train_test_split(X_0, y_0, test_size <span class="op">=</span> <span class="fl">0.2</span>, random_state <span class="op">=</span> <span class="dv">40</span>)</span>
<span id="cb33-126"><a href="#cb33-126" aria-hidden="true" tabindex="-1"></a>X_val, X_test, y_val, y_test <span class="op">=</span> train_test_split(X_test, y_test, test_size <span class="op">=</span> <span class="fl">0.5</span>, random_state <span class="op">=</span> <span class="dv">40</span>)</span>
<span id="cb33-127"><a href="#cb33-127" aria-hidden="true" tabindex="-1"></a>data_val_1, data_test_1 <span class="op">=</span> pd.concat([X_val, y_val], axis <span class="op">=</span> <span class="dv">1</span>), pd.concat([X_test, y_test], axis <span class="op">=</span> <span class="dv">1</span>)</span>
<span id="cb33-128"><a href="#cb33-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-129"><a href="#cb33-129" aria-hidden="true" tabindex="-1"></a><span class="co"># Splitting the fraudulent class</span></span>
<span id="cb33-130"><a href="#cb33-130" aria-hidden="true" tabindex="-1"></a>X_val, X_test, y_val, y_test <span class="op">=</span> train_test_split(X_1, y_1, test_size <span class="op">=</span> <span class="fl">0.5</span>, random_state <span class="op">=</span> <span class="dv">40</span>)</span>
<span id="cb33-131"><a href="#cb33-131" aria-hidden="true" tabindex="-1"></a>data_val_2, data_test_2 <span class="op">=</span> pd.concat([X_val, y_val], axis <span class="op">=</span> <span class="dv">1</span>), pd.concat([X_test, y_test], axis <span class="op">=</span> <span class="dv">1</span>)</span>
<span id="cb33-132"><a href="#cb33-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-133"><a href="#cb33-133" aria-hidden="true" tabindex="-1"></a><span class="co"># Merging data to construct the validation set and the test set</span></span>
<span id="cb33-134"><a href="#cb33-134" aria-hidden="true" tabindex="-1"></a>data_val, data_test <span class="op">=</span> pd.concat([data_val_1, data_val_2], axis <span class="op">=</span> <span class="dv">0</span>), pd.concat([data_test_1, data_test_2], axis <span class="op">=</span> <span class="dv">0</span>)</span>
<span id="cb33-135"><a href="#cb33-135" aria-hidden="true" tabindex="-1"></a>X_val, y_val <span class="op">=</span> data_val.drop(<span class="st">'Class'</span>, axis <span class="op">=</span> <span class="dv">1</span>), data_val[<span class="st">'Class'</span>]</span>
<span id="cb33-136"><a href="#cb33-136" aria-hidden="true" tabindex="-1"></a>X_test, y_test <span class="op">=</span> data_test.drop(<span class="st">'Class'</span>, axis <span class="op">=</span> <span class="dv">1</span>), data_test[<span class="st">'Class'</span>]</span>
<span id="cb33-137"><a href="#cb33-137" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-138"><a href="#cb33-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-139"><a href="#cb33-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-142"><a href="#cb33-142" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb33-143"><a href="#cb33-143" aria-hidden="true" tabindex="-1"></a><span class="co"># Distribution of authentic and fraudulent transactions over training, validation and test set</span></span>
<span id="cb33-144"><a href="#cb33-144" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> [<span class="st">'Train'</span>, <span class="st">'Validation'</span>, <span class="st">'Test'</span>]</span>
<span id="cb33-145"><a href="#cb33-145" aria-hidden="true" tabindex="-1"></a>values_0 <span class="op">=</span> [<span class="bu">len</span>(y_train[y_train <span class="op">==</span> <span class="dv">0</span>]), <span class="bu">len</span>(y_val[y_val <span class="op">==</span> <span class="dv">0</span>]), <span class="bu">len</span>(y_test[y_test <span class="op">==</span> <span class="dv">0</span>])]</span>
<span id="cb33-146"><a href="#cb33-146" aria-hidden="true" tabindex="-1"></a>values_1 <span class="op">=</span> [<span class="bu">len</span>(y_train[y_train <span class="op">==</span> <span class="dv">1</span>]), <span class="bu">len</span>(y_val[y_val <span class="op">==</span> <span class="dv">1</span>]), <span class="bu">len</span>(y_test[y_test <span class="op">==</span> <span class="dv">1</span>])]</span>
<span id="cb33-147"><a href="#cb33-147" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> make_subplots(rows <span class="op">=</span> <span class="dv">1</span>, cols <span class="op">=</span> <span class="dv">2</span>, specs <span class="op">=</span> [[{<span class="st">'type'</span>: <span class="st">'domain'</span>}, {<span class="st">'type'</span>: <span class="st">'domain'</span>}]])</span>
<span id="cb33-148"><a href="#cb33-148" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Pie(values <span class="op">=</span> values_0, labels <span class="op">=</span> labels, hole <span class="op">=</span> <span class="fl">0.5</span>, textinfo <span class="op">=</span> <span class="st">'percent'</span>, title <span class="op">=</span> <span class="st">"Authentic"</span>),</span>
<span id="cb33-149"><a href="#cb33-149" aria-hidden="true" tabindex="-1"></a>              row <span class="op">=</span> <span class="dv">1</span>, col <span class="op">=</span> <span class="dv">1</span>)</span>
<span id="cb33-150"><a href="#cb33-150" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Pie(values <span class="op">=</span> values_1, labels <span class="op">=</span> labels, hole <span class="op">=</span> <span class="fl">0.5</span>, textinfo <span class="op">=</span> <span class="st">'percent'</span>, title <span class="op">=</span> <span class="st">"Fraudulent"</span>),</span>
<span id="cb33-151"><a href="#cb33-151" aria-hidden="true" tabindex="-1"></a>              row <span class="op">=</span> <span class="dv">1</span>, col <span class="op">=</span> <span class="dv">2</span>)</span>
<span id="cb33-152"><a href="#cb33-152" aria-hidden="true" tabindex="-1"></a>text_title <span class="op">=</span> <span class="st">"Distribution of authentic and fraudulent transactions over training, validation and test set"</span></span>
<span id="cb33-153"><a href="#cb33-153" aria-hidden="true" tabindex="-1"></a>fig.update_layout(height <span class="op">=</span> <span class="dv">500</span>, width <span class="op">=</span> <span class="dv">800</span>, showlegend <span class="op">=</span> <span class="va">True</span>, title <span class="op">=</span> <span class="bu">dict</span>(text <span class="op">=</span> text_title, x <span class="op">=</span> <span class="fl">0.5</span>, y <span class="op">=</span> <span class="fl">0.95</span>)) </span>
<span id="cb33-154"><a href="#cb33-154" aria-hidden="true" tabindex="-1"></a>fig.show()</span>
<span id="cb33-155"><a href="#cb33-155" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-156"><a href="#cb33-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-159"><a href="#cb33-159" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb33-160"><a href="#cb33-160" aria-hidden="true" tabindex="-1"></a><span class="co"># Setting the number of bins</span></span>
<span id="cb33-161"><a href="#cb33-161" aria-hidden="true" tabindex="-1"></a>bins_train <span class="op">=</span> math.floor(<span class="bu">len</span>(X_train)<span class="op">**</span>(<span class="dv">1</span><span class="op">/</span><span class="dv">3</span>))</span>
<span id="cb33-162"><a href="#cb33-162" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-163"><a href="#cb33-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-164"><a href="#cb33-164" aria-hidden="true" tabindex="-1"></a><span class="fu">## Feature Engineering</span></span>
<span id="cb33-165"><a href="#cb33-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-166"><a href="#cb33-166" aria-hidden="true" tabindex="-1"></a><span class="fu">### Time</span></span>
<span id="cb33-167"><a href="#cb33-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-170"><a href="#cb33-170" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb33-171"><a href="#cb33-171" aria-hidden="true" tabindex="-1"></a><span class="co"># Decomposing time</span></span>
<span id="cb33-172"><a href="#cb33-172" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> df <span class="kw">in</span> [X_train, X_val, X_test]:</span>
<span id="cb33-173"><a href="#cb33-173" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'Day'</span>], temp <span class="op">=</span> df[<span class="st">'Time'</span>] <span class="op">//</span> (<span class="dv">24</span><span class="op">*</span><span class="dv">60</span><span class="op">*</span><span class="dv">60</span>), df[<span class="st">'Time'</span>] <span class="op">%</span> (<span class="dv">24</span><span class="op">*</span><span class="dv">60</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb33-174"><a href="#cb33-174" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'Hour'</span>], temp <span class="op">=</span> temp <span class="op">//</span> (<span class="dv">60</span><span class="op">*</span><span class="dv">60</span>), temp <span class="op">%</span> (<span class="dv">60</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb33-175"><a href="#cb33-175" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'Minute'</span>], df[<span class="st">'Second'</span>] <span class="op">=</span> temp <span class="op">//</span> <span class="dv">60</span>, temp <span class="op">%</span> <span class="dv">60</span></span>
<span id="cb33-176"><a href="#cb33-176" aria-hidden="true" tabindex="-1"></a>X_train[[<span class="st">'Time'</span>, <span class="st">'Day'</span>, <span class="st">'Hour'</span>, <span class="st">'Minute'</span>, <span class="st">'Second'</span>]].head()</span>
<span id="cb33-177"><a href="#cb33-177" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-178"><a href="#cb33-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-181"><a href="#cb33-181" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb33-182"><a href="#cb33-182" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualization</span></span>
<span id="cb33-183"><a href="#cb33-183" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize <span class="op">=</span> (<span class="dv">15</span>, <span class="dv">6</span>), sharey <span class="op">=</span> <span class="va">False</span>)</span>
<span id="cb33-184"><a href="#cb33-184" aria-hidden="true" tabindex="-1"></a>sns.histplot(data <span class="op">=</span> X_train, x <span class="op">=</span> <span class="st">'Time'</span>, bins <span class="op">=</span> bins_train, ax <span class="op">=</span> ax[<span class="dv">0</span>])</span>
<span id="cb33-185"><a href="#cb33-185" aria-hidden="true" tabindex="-1"></a>sns.histplot(data <span class="op">=</span> X_train, x <span class="op">=</span> <span class="st">'Hour'</span>, bins <span class="op">=</span> <span class="dv">24</span>, ax <span class="op">=</span> ax[<span class="dv">1</span>])</span>
<span id="cb33-186"><a href="#cb33-186" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].set_ylabel(<span class="st">" "</span>)</span>
<span id="cb33-187"><a href="#cb33-187" aria-hidden="true" tabindex="-1"></a>plt.suptitle(<span class="st">"Histograms of Time and Hour"</span>, size <span class="op">=</span> <span class="dv">14</span>)</span>
<span id="cb33-188"><a href="#cb33-188" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb33-189"><a href="#cb33-189" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb33-190"><a href="#cb33-190" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-191"><a href="#cb33-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-192"><a href="#cb33-192" aria-hidden="true" tabindex="-1"></a><span class="fu">## Amount</span></span>
<span id="cb33-193"><a href="#cb33-193" aria-hidden="true" tabindex="-1"></a>The distribution of Amount has extreme positive skewness. We apply the transformation  x↦log(x+0.001)</span>
<span id="cb33-194"><a href="#cb33-194" aria-hidden="true" tabindex="-1"></a>  to this column and form the new column Amount_transformed. The positive constant  0.001</span>
<span id="cb33-195"><a href="#cb33-195" aria-hidden="true" tabindex="-1"></a>  is added to deal with the zero-amount transactions, which leads to  log 0, an undefined quantity.</span>
<span id="cb33-196"><a href="#cb33-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-199"><a href="#cb33-199" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb33-200"><a href="#cb33-200" aria-hidden="true" tabindex="-1"></a><span class="co"># Transformation of 'Amount'</span></span>
<span id="cb33-201"><a href="#cb33-201" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> df <span class="kw">in</span> [X_train, X_val, X_test]:</span>
<span id="cb33-202"><a href="#cb33-202" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'Amount_transformed'</span>] <span class="op">=</span> np.log10(df[<span class="st">'Amount'</span>] <span class="op">+</span> <span class="fl">0.001</span>)</span>
<span id="cb33-203"><a href="#cb33-203" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-204"><a href="#cb33-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-207"><a href="#cb33-207" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb33-208"><a href="#cb33-208" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualization</span></span>
<span id="cb33-209"><a href="#cb33-209" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize <span class="op">=</span> (<span class="dv">15</span>, <span class="dv">6</span>), sharey <span class="op">=</span> <span class="va">False</span>)</span>
<span id="cb33-210"><a href="#cb33-210" aria-hidden="true" tabindex="-1"></a>sns.histplot(data <span class="op">=</span> X_train, x <span class="op">=</span> <span class="st">'Amount'</span>, bins <span class="op">=</span> bins_train, ax <span class="op">=</span> ax[<span class="dv">0</span>])</span>
<span id="cb33-211"><a href="#cb33-211" aria-hidden="true" tabindex="-1"></a>sns.histplot(data <span class="op">=</span> X_train, x <span class="op">=</span> <span class="st">'Amount_transformed'</span>, bins <span class="op">=</span> bins_train, ax <span class="op">=</span> ax[<span class="dv">1</span>])</span>
<span id="cb33-212"><a href="#cb33-212" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].set_ylabel(<span class="st">" "</span>)</span>
<span id="cb33-213"><a href="#cb33-213" aria-hidden="true" tabindex="-1"></a>plt.suptitle(<span class="st">"Histograms of Amount and Amount_transformed"</span>, size <span class="op">=</span> <span class="dv">14</span>)</span>
<span id="cb33-214"><a href="#cb33-214" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb33-215"><a href="#cb33-215" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb33-216"><a href="#cb33-216" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-217"><a href="#cb33-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-220"><a href="#cb33-220" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb33-221"><a href="#cb33-221" aria-hidden="true" tabindex="-1"></a><span class="co"># Discarding unnecessary columns</span></span>
<span id="cb33-222"><a href="#cb33-222" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> df <span class="kw">in</span> [X_train, X_val, X_test]:</span>
<span id="cb33-223"><a href="#cb33-223" aria-hidden="true" tabindex="-1"></a>    df.drop([<span class="st">'Time'</span>, <span class="st">'Day'</span>, <span class="st">'Minute'</span>, <span class="st">'Second'</span>, <span class="st">'Amount'</span>], axis <span class="op">=</span> <span class="dv">1</span>, inplace <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb33-224"><a href="#cb33-224" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-225"><a href="#cb33-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-226"><a href="#cb33-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-227"><a href="#cb33-227" aria-hidden="true" tabindex="-1"></a><span class="fu"># Feature Selection</span></span>
<span id="cb33-228"><a href="#cb33-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-231"><a href="#cb33-231" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb33-232"><a href="#cb33-232" aria-hidden="true" tabindex="-1"></a><span class="co"># Comparison of feature distributions for different target classes</span></span>
<span id="cb33-233"><a href="#cb33-233" aria-hidden="true" tabindex="-1"></a>data_val <span class="op">=</span> pd.concat([X_val, y_val], axis <span class="op">=</span> <span class="dv">1</span>)</span>
<span id="cb33-234"><a href="#cb33-234" aria-hidden="true" tabindex="-1"></a>data_val_0, data_val_1 <span class="op">=</span> data_val[data_val[<span class="st">'Class'</span>] <span class="op">==</span> <span class="dv">0</span>], data_val[data_val[<span class="st">'Class'</span>] <span class="op">==</span> <span class="dv">1</span>]</span>
<span id="cb33-235"><a href="#cb33-235" aria-hidden="true" tabindex="-1"></a>cols, ncols <span class="op">=</span> <span class="bu">list</span>(X_val.columns), <span class="dv">3</span></span>
<span id="cb33-236"><a href="#cb33-236" aria-hidden="true" tabindex="-1"></a>nrows <span class="op">=</span> math.ceil(<span class="bu">len</span>(cols) <span class="op">/</span> ncols)</span>
<span id="cb33-237"><a href="#cb33-237" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(nrows, ncols, figsize <span class="op">=</span> (<span class="fl">4.5</span> <span class="op">*</span> ncols, <span class="dv">4</span> <span class="op">*</span> nrows))</span>
<span id="cb33-238"><a href="#cb33-238" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(cols)):</span>
<span id="cb33-239"><a href="#cb33-239" aria-hidden="true" tabindex="-1"></a>    sns.kdeplot(data_val_0[cols[i]], ax <span class="op">=</span> ax[i <span class="op">//</span> ncols, i <span class="op">%</span> ncols])</span>
<span id="cb33-240"><a href="#cb33-240" aria-hidden="true" tabindex="-1"></a>    sns.kdeplot(data_val_1[cols[i]], ax <span class="op">=</span> ax[i <span class="op">//</span> ncols, i <span class="op">%</span> ncols])</span>
<span id="cb33-241"><a href="#cb33-241" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> i <span class="op">%</span> ncols <span class="op">!=</span> <span class="dv">0</span>:</span>
<span id="cb33-242"><a href="#cb33-242" aria-hidden="true" tabindex="-1"></a>        ax[i <span class="op">//</span> ncols, i <span class="op">%</span> ncols].set_ylabel(<span class="st">" "</span>)</span>
<span id="cb33-243"><a href="#cb33-243" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb33-244"><a href="#cb33-244" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb33-245"><a href="#cb33-245" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-246"><a href="#cb33-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-249"><a href="#cb33-249" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb33-250"><a href="#cb33-250" aria-hidden="true" tabindex="-1"></a><span class="co"># Feature selection</span></span>
<span id="cb33-251"><a href="#cb33-251" aria-hidden="true" tabindex="-1"></a>cols <span class="op">=</span> [<span class="st">'V4'</span>, <span class="st">'V11'</span>, <span class="st">'V12'</span>, <span class="st">'V14'</span>, <span class="st">'V16'</span>, <span class="st">'V17'</span>, <span class="st">'V18'</span>, <span class="st">'V19'</span>, <span class="st">'Hour'</span>]</span>
<span id="cb33-252"><a href="#cb33-252" aria-hidden="true" tabindex="-1"></a>X_train_fs, X_val_fs, X_test_fs <span class="op">=</span> X_train[cols], X_val[cols], X_test[cols]</span>
<span id="cb33-253"><a href="#cb33-253" aria-hidden="true" tabindex="-1"></a>X_train_fs.head()</span>
<span id="cb33-254"><a href="#cb33-254" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-255"><a href="#cb33-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-256"><a href="#cb33-256" aria-hidden="true" tabindex="-1"></a><span class="fu">## Implementing Anomaly Detection</span></span>
<span id="cb33-257"><a href="#cb33-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-260"><a href="#cb33-260" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb33-261"><a href="#cb33-261" aria-hidden="true" tabindex="-1"></a><span class="co"># Normal pdf</span></span>
<span id="cb33-262"><a href="#cb33-262" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> normal_density(x, mu, sigma):</span>
<span id="cb33-263"><a href="#cb33-263" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb33-264"><a href="#cb33-264" aria-hidden="true" tabindex="-1"></a><span class="co">    Computes univariate normal probability density function (pdf) with mean mu, standard deviation sigma</span></span>
<span id="cb33-265"><a href="#cb33-265" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb33-266"><a href="#cb33-266" aria-hidden="true" tabindex="-1"></a><span class="co">      x (scalar)    : input observation</span></span>
<span id="cb33-267"><a href="#cb33-267" aria-hidden="true" tabindex="-1"></a><span class="co">      mu (scalar)   : mean</span></span>
<span id="cb33-268"><a href="#cb33-268" aria-hidden="true" tabindex="-1"></a><span class="co">      sigma (scalar): standard deviation (&gt; 0)</span></span>
<span id="cb33-269"><a href="#cb33-269" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb33-270"><a href="#cb33-270" aria-hidden="true" tabindex="-1"></a><span class="co">      f (scalar): value of the univariate normal pdf</span></span>
<span id="cb33-271"><a href="#cb33-271" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb33-272"><a href="#cb33-272" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> sigma <span class="op">&gt;</span> <span class="dv">0</span>, <span class="st">"Standard deviation must be positive"</span></span>
<span id="cb33-273"><a href="#cb33-273" aria-hidden="true" tabindex="-1"></a>    f <span class="op">=</span> (<span class="dv">1</span> <span class="op">/</span> (sigma <span class="op">*</span> np.sqrt(<span class="dv">2</span> <span class="op">*</span> np.pi))) <span class="op">*</span> np.exp(<span class="op">-</span> (<span class="dv">1</span> <span class="op">/</span> <span class="dv">2</span>) <span class="op">*</span> ((x <span class="op">-</span> mu) <span class="op">/</span> sigma)<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb33-274"><a href="#cb33-274" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> f</span>
<span id="cb33-275"><a href="#cb33-275" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-276"><a href="#cb33-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-279"><a href="#cb33-279" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb33-280"><a href="#cb33-280" aria-hidden="true" tabindex="-1"></a><span class="co"># Product of normal pdfs</span></span>
<span id="cb33-281"><a href="#cb33-281" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> normal_product(x_vec, mu_vec, sigma_vec):</span>
<span id="cb33-282"><a href="#cb33-282" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb33-283"><a href="#cb33-283" aria-hidden="true" tabindex="-1"></a><span class="co">    Computes product of univariate normal densities</span></span>
<span id="cb33-284"><a href="#cb33-284" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb33-285"><a href="#cb33-285" aria-hidden="true" tabindex="-1"></a><span class="co">      x_vec (array_like, shape (n,))    : vector of input observations</span></span>
<span id="cb33-286"><a href="#cb33-286" aria-hidden="true" tabindex="-1"></a><span class="co">      mu_vec (array_like, shape (n,))   : vector of means</span></span>
<span id="cb33-287"><a href="#cb33-287" aria-hidden="true" tabindex="-1"></a><span class="co">      sigma_vec (array_like, shape (n,)): vector of standard deviations (&gt; 0)</span></span>
<span id="cb33-288"><a href="#cb33-288" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb33-289"><a href="#cb33-289" aria-hidden="true" tabindex="-1"></a><span class="co">      f (scalar): product of univariate normal densities</span></span>
<span id="cb33-290"><a href="#cb33-290" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb33-291"><a href="#cb33-291" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="bu">min</span>(sigma_vec) <span class="op">&gt;</span> <span class="dv">0</span>, <span class="st">"Standard deviation must be positive"</span></span>
<span id="cb33-292"><a href="#cb33-292" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="bu">len</span>(mu_vec) <span class="op">==</span> <span class="bu">len</span>(x_vec), <span class="st">"Length of mean vector does not match length of input vector"</span></span>
<span id="cb33-293"><a href="#cb33-293" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="bu">len</span>(sigma_vec) <span class="op">==</span> <span class="bu">len</span>(x_vec), <span class="st">"Length of standard deviation vector does not match length of input vector"</span></span>
<span id="cb33-294"><a href="#cb33-294" aria-hidden="true" tabindex="-1"></a>    f <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb33-295"><a href="#cb33-295" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(x_vec)):</span>
<span id="cb33-296"><a href="#cb33-296" aria-hidden="true" tabindex="-1"></a>        f <span class="op">=</span> f <span class="op">*</span> normal_density(x_vec[i], mu_vec[i], sigma_vec[i])</span>
<span id="cb33-297"><a href="#cb33-297" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> f</span>
<span id="cb33-298"><a href="#cb33-298" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-299"><a href="#cb33-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-300"><a href="#cb33-300" aria-hidden="true" tabindex="-1"></a>Next, we compute the vector of means and vector of standard deviations for the features in the training set. These estimates characterize the joint probability density function of the features, which will be used to detect anomalous observations.</span>
<span id="cb33-301"><a href="#cb33-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-304"><a href="#cb33-304" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb33-305"><a href="#cb33-305" aria-hidden="true" tabindex="-1"></a><span class="co"># Model fitting</span></span>
<span id="cb33-306"><a href="#cb33-306" aria-hidden="true" tabindex="-1"></a>mu_train, sigma_train <span class="op">=</span> X_train_fs.mean(), X_train_fs.std()</span>
<span id="cb33-307"><a href="#cb33-307" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-310"><a href="#cb33-310" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb33-311"><a href="#cb33-311" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to predict anomaly based on probability density threshold</span></span>
<span id="cb33-312"><a href="#cb33-312" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> model_normal(X, epsilon):</span>
<span id="cb33-313"><a href="#cb33-313" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb33-314"><a href="#cb33-314" aria-hidden="true" tabindex="-1"></a><span class="co">    Anomaly detection model</span></span>
<span id="cb33-315"><a href="#cb33-315" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb33-316"><a href="#cb33-316" aria-hidden="true" tabindex="-1"></a><span class="co">      X (DataFrame, shape (m, n)): DataFrame of features</span></span>
<span id="cb33-317"><a href="#cb33-317" aria-hidden="true" tabindex="-1"></a><span class="co">      epsilon (scalar)           : threshold density value (&gt; 0)</span></span>
<span id="cb33-318"><a href="#cb33-318" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb33-319"><a href="#cb33-319" aria-hidden="true" tabindex="-1"></a><span class="co">      y (array_like, shape (m,)): predicted class labels</span></span>
<span id="cb33-320"><a href="#cb33-320" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb33-321"><a href="#cb33-321" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> []</span>
<span id="cb33-322"><a href="#cb33-322" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> X.index:</span>
<span id="cb33-323"><a href="#cb33-323" aria-hidden="true" tabindex="-1"></a>        prob_density <span class="op">=</span> normal_product(X.loc[i].tolist(), mu_train, sigma_train)</span>
<span id="cb33-324"><a href="#cb33-324" aria-hidden="true" tabindex="-1"></a>        y.append((prob_density <span class="op">&lt;</span> epsilon).astype(<span class="bu">int</span>))</span>
<span id="cb33-325"><a href="#cb33-325" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> y</span>
<span id="cb33-326"><a href="#cb33-326" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-327"><a href="#cb33-327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-328"><a href="#cb33-328" aria-hidden="true" tabindex="-1"></a><span class="fu">## Threshold Tuning on Validation Set</span></span>
<span id="cb33-329"><a href="#cb33-329" aria-hidden="true" tabindex="-1"></a>First, we construct some functions to compute and display the confusion matrix and to compute the  F2-score, given the true labels and the predicted labels of the target.</span>
<span id="cb33-330"><a href="#cb33-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-333"><a href="#cb33-333" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb33-334"><a href="#cb33-334" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to compute confusion matrix</span></span>
<span id="cb33-335"><a href="#cb33-335" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> conf_mat(y_test, y_pred):</span>
<span id="cb33-336"><a href="#cb33-336" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb33-337"><a href="#cb33-337" aria-hidden="true" tabindex="-1"></a><span class="co">    Computes confusion matrix</span></span>
<span id="cb33-338"><a href="#cb33-338" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb33-339"><a href="#cb33-339" aria-hidden="true" tabindex="-1"></a><span class="co">      y_test (array_like): true binary (0 or 1) labels</span></span>
<span id="cb33-340"><a href="#cb33-340" aria-hidden="true" tabindex="-1"></a><span class="co">      y_pred (array_like): predicted binary (0 or 1) labels</span></span>
<span id="cb33-341"><a href="#cb33-341" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb33-342"><a href="#cb33-342" aria-hidden="true" tabindex="-1"></a><span class="co">      confusion_mat (array): A 2D array representing a 2x2 confusion matrix</span></span>
<span id="cb33-343"><a href="#cb33-343" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb33-344"><a href="#cb33-344" aria-hidden="true" tabindex="-1"></a>    y_test, y_pred <span class="op">=</span> <span class="bu">list</span>(y_test), <span class="bu">list</span>(y_pred)</span>
<span id="cb33-345"><a href="#cb33-345" aria-hidden="true" tabindex="-1"></a>    count, labels, confusion_mat <span class="op">=</span> <span class="bu">len</span>(y_test), [<span class="dv">0</span>, <span class="dv">1</span>], np.zeros(shape <span class="op">=</span> (<span class="dv">2</span>, <span class="dv">2</span>), dtype <span class="op">=</span> <span class="bu">int</span>)</span>
<span id="cb33-346"><a href="#cb33-346" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">2</span>):</span>
<span id="cb33-347"><a href="#cb33-347" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">2</span>):</span>
<span id="cb33-348"><a href="#cb33-348" aria-hidden="true" tabindex="-1"></a>            confusion_mat[i][j] <span class="op">=</span> <span class="bu">len</span>([k <span class="cf">for</span> k <span class="kw">in</span> <span class="bu">range</span>(count) <span class="cf">if</span> y_test[k] <span class="op">==</span> labels[i] <span class="kw">and</span> y_pred[k] <span class="op">==</span> labels[j]])</span>
<span id="cb33-349"><a href="#cb33-349" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> confusion_mat</span>
<span id="cb33-350"><a href="#cb33-350" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-351"><a href="#cb33-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-354"><a href="#cb33-354" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb33-355"><a href="#cb33-355" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to print confusion matrix</span></span>
<span id="cb33-356"><a href="#cb33-356" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> conf_mat_heatmap(y_test, y_pred):</span>
<span id="cb33-357"><a href="#cb33-357" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb33-358"><a href="#cb33-358" aria-hidden="true" tabindex="-1"></a><span class="co">    Prints confusion matrix</span></span>
<span id="cb33-359"><a href="#cb33-359" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb33-360"><a href="#cb33-360" aria-hidden="true" tabindex="-1"></a><span class="co">      y_test (array_like): true binary (0 or 1) labels</span></span>
<span id="cb33-361"><a href="#cb33-361" aria-hidden="true" tabindex="-1"></a><span class="co">      y_pred (array_like): predicted binary (0 or 1) labels</span></span>
<span id="cb33-362"><a href="#cb33-362" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb33-363"><a href="#cb33-363" aria-hidden="true" tabindex="-1"></a><span class="co">      Nothing, prints a heatmap representing a 2x2 confusion matrix</span></span>
<span id="cb33-364"><a href="#cb33-364" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb33-365"><a href="#cb33-365" aria-hidden="true" tabindex="-1"></a>    confusion_mat <span class="op">=</span> conf_mat(y_test, y_pred)</span>
<span id="cb33-366"><a href="#cb33-366" aria-hidden="true" tabindex="-1"></a>    labels, confusion_mat_df <span class="op">=</span> [<span class="dv">0</span>, <span class="dv">1</span>], pd.DataFrame(confusion_mat, <span class="bu">range</span>(<span class="dv">2</span>), <span class="bu">range</span>(<span class="dv">2</span>))</span>
<span id="cb33-367"><a href="#cb33-367" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize <span class="op">=</span> (<span class="dv">6</span>, <span class="fl">4.75</span>))</span>
<span id="cb33-368"><a href="#cb33-368" aria-hidden="true" tabindex="-1"></a>    sns.heatmap(confusion_mat_df, annot <span class="op">=</span> <span class="va">True</span>, annot_kws <span class="op">=</span> {<span class="st">"size"</span>: <span class="dv">16</span>}, fmt <span class="op">=</span> <span class="st">'d'</span>)</span>
<span id="cb33-369"><a href="#cb33-369" aria-hidden="true" tabindex="-1"></a>    plt.xticks([<span class="fl">0.5</span>, <span class="fl">1.5</span>], labels, rotation <span class="op">=</span> <span class="st">'horizontal'</span>)</span>
<span id="cb33-370"><a href="#cb33-370" aria-hidden="true" tabindex="-1"></a>    plt.yticks([<span class="fl">0.5</span>, <span class="fl">1.5</span>], labels, rotation <span class="op">=</span> <span class="st">'horizontal'</span>)</span>
<span id="cb33-371"><a href="#cb33-371" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">"Predicted label"</span>, fontsize <span class="op">=</span> <span class="dv">14</span>)</span>
<span id="cb33-372"><a href="#cb33-372" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">"True label"</span>, fontsize <span class="op">=</span> <span class="dv">14</span>)</span>
<span id="cb33-373"><a href="#cb33-373" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="st">"Confusion Matrix"</span>, fontsize <span class="op">=</span> <span class="dv">14</span>)</span>
<span id="cb33-374"><a href="#cb33-374" aria-hidden="true" tabindex="-1"></a>    plt.grid(<span class="va">False</span>)</span>
<span id="cb33-375"><a href="#cb33-375" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb33-376"><a href="#cb33-376" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-377"><a href="#cb33-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-380"><a href="#cb33-380" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb33-381"><a href="#cb33-381" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to compute and return f2_score</span></span>
<span id="cb33-382"><a href="#cb33-382" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> f2_score(y_test, y_pred):</span>
<span id="cb33-383"><a href="#cb33-383" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb33-384"><a href="#cb33-384" aria-hidden="true" tabindex="-1"></a><span class="co">    Computes accuracy, given true and predicted binary (0 or 1) labels</span></span>
<span id="cb33-385"><a href="#cb33-385" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb33-386"><a href="#cb33-386" aria-hidden="true" tabindex="-1"></a><span class="co">      y_test (array_like): true binary (0 or 1) labels</span></span>
<span id="cb33-387"><a href="#cb33-387" aria-hidden="true" tabindex="-1"></a><span class="co">      y_pred (array_like): predicted binary (0 or 1) labels</span></span>
<span id="cb33-388"><a href="#cb33-388" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb33-389"><a href="#cb33-389" aria-hidden="true" tabindex="-1"></a><span class="co">      f2 (float): accuracy obtained from y_test and y_pred</span></span>
<span id="cb33-390"><a href="#cb33-390" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb33-391"><a href="#cb33-391" aria-hidden="true" tabindex="-1"></a>    confusion_mat <span class="op">=</span> conf_mat(y_test, y_pred)</span>
<span id="cb33-392"><a href="#cb33-392" aria-hidden="true" tabindex="-1"></a>    tn, fp, fn, tp <span class="op">=</span> confusion_mat[<span class="dv">0</span>, <span class="dv">0</span>], confusion_mat[<span class="dv">0</span>, <span class="dv">1</span>], confusion_mat[<span class="dv">1</span>, <span class="dv">0</span>], confusion_mat[<span class="dv">1</span>, <span class="dv">1</span>]</span>
<span id="cb33-393"><a href="#cb33-393" aria-hidden="true" tabindex="-1"></a>    f2 <span class="op">=</span> (<span class="dv">5</span> <span class="op">*</span> tp) <span class="op">/</span> ((<span class="dv">5</span> <span class="op">*</span> tp) <span class="op">+</span> (<span class="dv">4</span> <span class="op">*</span> fn) <span class="op">+</span> fp)</span>
<span id="cb33-394"><a href="#cb33-394" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> f2</span>
<span id="cb33-395"><a href="#cb33-395" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-396"><a href="#cb33-396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-399"><a href="#cb33-399" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb33-400"><a href="#cb33-400" aria-hidden="true" tabindex="-1"></a><span class="co"># Tuning the threshold of density value</span></span>
<span id="cb33-401"><a href="#cb33-401" aria-hidden="true" tabindex="-1"></a>alpha_list, f2_list, f2_max, alpha_opt, y_val_pred_opt <span class="op">=</span> [], [], <span class="fl">0.0</span>, <span class="fl">0.0</span>, np.zeros(<span class="bu">len</span>(y_val))</span>
<span id="cb33-402"><a href="#cb33-402" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> alpha, j <span class="kw">in</span> itertools.product(np.arange(<span class="fl">0.001</span>, <span class="fl">0.051</span>, <span class="fl">0.001</span>), <span class="bu">range</span>(<span class="dv">1</span>)):</span>
<span id="cb33-403"><a href="#cb33-403" aria-hidden="true" tabindex="-1"></a>    y_val_pred <span class="op">=</span> model_normal(X_val_fs, epsilon <span class="op">=</span> alpha<span class="op">**</span>X_val_fs.shape[<span class="dv">1</span>])</span>
<span id="cb33-404"><a href="#cb33-404" aria-hidden="true" tabindex="-1"></a>    f2 <span class="op">=</span> f2_score(y_val, y_val_pred)</span>
<span id="cb33-405"><a href="#cb33-405" aria-hidden="true" tabindex="-1"></a>    alpha_list.append(alpha)</span>
<span id="cb33-406"><a href="#cb33-406" aria-hidden="true" tabindex="-1"></a>    f2_list.append(f2)</span>
<span id="cb33-407"><a href="#cb33-407" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> f2 <span class="op">&gt;</span> f2_max:</span>
<span id="cb33-408"><a href="#cb33-408" aria-hidden="true" tabindex="-1"></a>        alpha_opt <span class="op">=</span> alpha</span>
<span id="cb33-409"><a href="#cb33-409" aria-hidden="true" tabindex="-1"></a>        y_val_pred_opt <span class="op">=</span> y_val_pred</span>
<span id="cb33-410"><a href="#cb33-410" aria-hidden="true" tabindex="-1"></a>        f2_max <span class="op">=</span> f2</span>
<span id="cb33-411"><a href="#cb33-411" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-412"><a href="#cb33-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-415"><a href="#cb33-415" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb33-416"><a href="#cb33-416" aria-hidden="true" tabindex="-1"></a><span class="co"># Plotting F2-score over alpha</span></span>
<span id="cb33-417"><a href="#cb33-417" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize <span class="op">=</span> (<span class="dv">9</span>, <span class="dv">6</span>))</span>
<span id="cb33-418"><a href="#cb33-418" aria-hidden="true" tabindex="-1"></a>plt.plot(alpha_list, f2_list)</span>
<span id="cb33-419"><a href="#cb33-419" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"alpha"</span>, fontsize <span class="op">=</span> <span class="dv">14</span>)</span>
<span id="cb33-420"><a href="#cb33-420" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"F2-score"</span>, fontsize <span class="op">=</span> <span class="dv">14</span>)</span>
<span id="cb33-421"><a href="#cb33-421" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"F2-score vs alpha"</span>, fontsize <span class="op">=</span> <span class="dv">14</span>)</span>
<span id="cb33-422"><a href="#cb33-422" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb33-423"><a href="#cb33-423" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb33-424"><a href="#cb33-424" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-427"><a href="#cb33-427" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb33-428"><a href="#cb33-428" aria-hidden="true" tabindex="-1"></a><span class="co"># Tuning summary</span></span>
<span id="cb33-429"><a href="#cb33-429" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(pd.Series({</span>
<span id="cb33-430"><a href="#cb33-430" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Optimal alpha"</span>: alpha_opt,</span>
<span id="cb33-431"><a href="#cb33-431" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Optimal F2-score"</span>: f2_score(y_val, y_val_pred_opt)</span>
<span id="cb33-432"><a href="#cb33-432" aria-hidden="true" tabindex="-1"></a>}).to_string())</span>
<span id="cb33-433"><a href="#cb33-433" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-436"><a href="#cb33-436" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb33-437"><a href="#cb33-437" aria-hidden="true" tabindex="-1"></a><span class="co"># Confusion matrix for predictions on the validation set</span></span>
<span id="cb33-438"><a href="#cb33-438" aria-hidden="true" tabindex="-1"></a>conf_mat_heatmap(y_val, y_val_pred_opt)</span>
<span id="cb33-439"><a href="#cb33-439" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-440"><a href="#cb33-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-441"><a href="#cb33-441" aria-hidden="true" tabindex="-1"></a><span class="fu">## Prediction and Evaluation on Test Set</span></span>
<span id="cb33-442"><a href="#cb33-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-445"><a href="#cb33-445" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb33-446"><a href="#cb33-446" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to compute and print evaluation metrics</span></span>
<span id="cb33-447"><a href="#cb33-447" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> evaluation(y_test, y_pred):</span>
<span id="cb33-448"><a href="#cb33-448" aria-hidden="true" tabindex="-1"></a>    confusion_mat <span class="op">=</span> conf_mat(y_test, y_pred)</span>
<span id="cb33-449"><a href="#cb33-449" aria-hidden="true" tabindex="-1"></a>    tn, fp, fn, tp <span class="op">=</span> confusion_mat[<span class="dv">0</span>, <span class="dv">0</span>], confusion_mat[<span class="dv">0</span>, <span class="dv">1</span>], confusion_mat[<span class="dv">1</span>, <span class="dv">0</span>], confusion_mat[<span class="dv">1</span>, <span class="dv">1</span>]</span>
<span id="cb33-450"><a href="#cb33-450" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(pd.Series({</span>
<span id="cb33-451"><a href="#cb33-451" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Accuracy"</span>: (tp <span class="op">+</span> tn) <span class="op">/</span> (tn <span class="op">+</span> fp <span class="op">+</span> fn <span class="op">+</span> tp),</span>
<span id="cb33-452"><a href="#cb33-452" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Precision"</span>: tp <span class="op">/</span> (tp <span class="op">+</span> fp),</span>
<span id="cb33-453"><a href="#cb33-453" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Recall"</span>: tp <span class="op">/</span> (tp <span class="op">+</span> fn),</span>
<span id="cb33-454"><a href="#cb33-454" aria-hidden="true" tabindex="-1"></a>        <span class="st">"F1-score"</span>: (<span class="dv">2</span> <span class="op">*</span> tp) <span class="op">/</span> ((<span class="dv">2</span> <span class="op">*</span> tp) <span class="op">+</span> fn <span class="op">+</span> fp),</span>
<span id="cb33-455"><a href="#cb33-455" aria-hidden="true" tabindex="-1"></a>        <span class="st">"F2-score"</span>: (<span class="dv">5</span> <span class="op">*</span> tp) <span class="op">/</span> ((<span class="dv">5</span> <span class="op">*</span> tp) <span class="op">+</span> (<span class="dv">4</span> <span class="op">*</span> fn) <span class="op">+</span> fp),</span>
<span id="cb33-456"><a href="#cb33-456" aria-hidden="true" tabindex="-1"></a>        <span class="st">"MCC"</span>: ((tp <span class="op">*</span> tn) <span class="op">-</span> (fp <span class="op">*</span> fn)) <span class="op">/</span> np.sqrt((tp <span class="op">+</span> fp) <span class="op">*</span> (tp <span class="op">+</span> fn) <span class="op">*</span> (tn <span class="op">+</span> fp) <span class="op">*</span> (tn <span class="op">+</span> fn))</span>
<span id="cb33-457"><a href="#cb33-457" aria-hidden="true" tabindex="-1"></a>    }).to_string())</span>
<span id="cb33-458"><a href="#cb33-458" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-459"><a href="#cb33-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-462"><a href="#cb33-462" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb33-463"><a href="#cb33-463" aria-hidden="true" tabindex="-1"></a><span class="co"># Prediction and evaluation on the test set</span></span>
<span id="cb33-464"><a href="#cb33-464" aria-hidden="true" tabindex="-1"></a>y_test_normal <span class="op">=</span> model_normal(X_test_fs, epsilon <span class="op">=</span> alpha_opt<span class="op">**</span>X_test_fs.shape[<span class="dv">1</span>])</span>
<span id="cb33-465"><a href="#cb33-465" aria-hidden="true" tabindex="-1"></a>evaluation(y_test, y_test_normal)</span>
<span id="cb33-466"><a href="#cb33-466" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-467"><a href="#cb33-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-470"><a href="#cb33-470" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb33-471"><a href="#cb33-471" aria-hidden="true" tabindex="-1"></a><span class="co"># Confusion matrix for predictions on the test set</span></span>
<span id="cb33-472"><a href="#cb33-472" aria-hidden="true" tabindex="-1"></a>conf_mat_heatmap(y_test, y_test_normal)</span>
<span id="cb33-473"><a href="#cb33-473" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-474"><a href="#cb33-474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-475"><a href="#cb33-475" aria-hidden="true" tabindex="-1"></a><span class="fu">## Conclusion</span></span>
<span id="cb33-476"><a href="#cb33-476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-477"><a href="#cb33-477" aria-hidden="true" tabindex="-1"></a>Here, we addressed the challenge of a highly imbalanced dataset in credit card transactions, where fraudulent transactions are significantly less frequent compared to legitimate ones. The approach involved sophisticated feature engineering, where we extracted 'Hour' from the 'Time' attribute and log-transformed the 'Amount' feature to correct for skewness, resulting in a new feature called 'Amount_transformed'.</span>
<span id="cb33-478"><a href="#cb33-478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-479"><a href="#cb33-479" aria-hidden="true" tabindex="-1"></a>A crucial step in the analysis was the selection of key features that show distinct distribution patterns across the two classes of transactions. Out of 30 features engineered, 9 (V4, V11, V12, V14, V16, V17, V18, V19, and Hour) were identified as significantly influential in distinguishing between fraudulent and legitimate transactions. These features were used to fit a multivariate normal distribution to the training data, under the assumption of statistical independence among features, a reasonable assumption given that most of the features were obtained through PCA.</span>
<span id="cb33-480"><a href="#cb33-480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-481"><a href="#cb33-481" aria-hidden="true" tabindex="-1"></a>The final phase of the project involved optimizing a threshold for anomaly detection. This was achieved by iterating over a range of values and evaluating their performance using the F2-score on the validation set. The optimal threshold was found to be approximately 0.0099. With this threshold, the model achieved an F2-score of 0.834671 on the validation set. When applied to the test set, the model demonstrated a consistent performance with an F2-score of 0.816492. This method proved effective in flagging transactions as fraudulent based on their density values in the fitted distribution.</span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



</body></html>